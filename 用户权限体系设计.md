# 用户权限体系设计

> **版本**: v1.0
> **更新日期**: 2025-12-21
> **说明**: Line账号管理系统的完整权限体系设计

---

## 📊 权限层级结构

```
┌─────────────────────────────────────────────────────────┐
│                      管理员                              │
│  - 管理所有普通用户                                      │
│  - 查看所有数据                                          │
│  - 配置系统参数                                          │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
┌───────▼───────┐              ┌──────▼──────┐
│  普通用户A     │              │  普通用户B   │
│  - 创建分组    │              │  - 创建分组  │
│  - 管理分组    │              │  - 管理分组  │
└───────┬───────┘              └──────┬──────┘
        │                             │
   ┌────┴────┬────┐            ┌─────┴─────┐
   │         │    │            │           │
┌──▼──┐  ┌──▼──┐ │         ┌──▼──┐    ┌──▼──┐
│分组1│  │分组2│ │         │分组1│    │分组2│
│激活码│  │激活码│ │         │激活码│    │激活码│
│ABC  │  │DEF  │...        │XYZ  │    │MNO  │
│     │  │     │           │     │    │     │
│子账号│  │子账号│          │子账号│    │子账号│
└─────┘  └─────┘           └─────┘    └─────┘
```

---

## 👥 角色详细说明

### 1. 管理员（Admin）

#### 权限范围
- **用户管理**: 创建、编辑、删除普通用户
- **全局数据访问**: 查看所有普通用户及其分组的数据
- **系统配置**: 配置系统参数、大模型API等

#### 可访问页面
- ✅ 分组管理（所有分组）
- ✅ 账号列表（所有账号）
- ✅ 线索列表（所有线索）
- ✅ 底库管理（所有底库）
- ✅ 客户列表（所有客户）
- ✅ 跟进记录（所有记录）
- ✅ 用户管理（管理员专用）
- ✅ 系统配置（管理员专用）

#### 操作权限
- ✅ 完全权限（CRUD）

---

### 2. 普通用户（User）

#### 权限范围
- **分组管理**: 创建、管理自己的分组（激活码）
- **数据范围**: 只能看到自己创建的所有分组及其数据
- **子账号管理**: 每个分组就是一个子账号

#### 可访问页面
- ✅ 分组管理（只看自己的分组）
- ✅ 账号列表（只看自己分组的账号）
- ✅ 线索列表（只看自己分组的线索）
- ✅ 底库管理（只看自己分组的底库）
- ✅ 客户列表（只看自己分组的客户）
- ✅ 跟进记录（只看自己分组的记录）

#### 操作权限
- ✅ 完全操作权限（针对自己的数据）
- ✅ 创建分组（激活码）
- ✅ 修改分组配置
- ✅ 禁用/启用分组
- ✅ 删除分组

#### 创建分组
普通用户创建分组时，系统会：
1. 自动生成激活码（8位随机字符串）
2. 创建分组记录
3. 该分组同时作为一个子账号

---

### 3. 子账号（分组）

#### 权限范围
- **数据范围**: 只能看到自己分组的数据
- **操作权限**: 和普通用户一样的操作权限，但仅限于自己分组

#### 可访问页面
- ✅ 线索列表（只看自己分组）
- ✅ 底库管理（只看自己分组）
- ✅ 账号列表（只看自己分组）
- ✅ 客户列表（只看自己分组）
- ✅ 跟进记录（只看自己分组）
- ❌ 分组管理（不显示，因为只有一个分组）
- ❌ 用户管理（不可访问）
- ❌ 系统配置（不可访问）

#### 操作权限
- ✅ 和普通用户完全相同的操作权限
- ✅ 查看、编辑、删除自己分组的数据
- ✅ 添加跟进记录
- ✅ 编辑客户信息
- ✅ 导入底库联系人
- ✅ 查看Line账号详情
- ✅ 删除自己的分组
- ❌ 不能创建新分组

---

## 🔑 登录认证

### 管理员登录
- **登录方式**: 用户名 + 密码
- **登录页面**: 管理后台登录页
- **登录后角色**: `admin`

### 普通用户登录
- **登录方式**: 用户名 + 密码
- **登录页面**: 管理后台登录页
- **登录后角色**: `user`

### 子账号登录
- **登录方式**: 激活码 + 密码（可选）
- **登录页面**: 子账号登录页（或管理后台登录页）
- **登录逻辑**:
  1. 输入激活码
  2. 系统查询该激活码对应的分组
  3. 如果该分组设置了密码，则需要输入密码验证
  4. 如果未设置密码，直接用激活码登录
  5. 登录成功后，角色标识为 `sub_account`，权限范围限定为该分组
- **登录后角色**: `sub_account`

**数据库字段**:
```sql
ALTER TABLE groups ADD COLUMN login_password VARCHAR(255);  -- 子账号登录密码（可选）
```

---

## 💻 Windows客户端与激活码

### 客户端登录机制

#### 多激活码支持
- **一个Windows客户端可以同时登录多个激活码**
- 每个激活码对应一个分组
- 客户端可以在多个分组间切换或同时管理

#### 登录流程
```
1. Windows客户端启动
2. 用户添加激活码（可添加多个）
3. 对每个激活码建立独立的WebSocket连接
4. 每个连接独立上报数据
```

### 数据归属逻辑

**关键原则**: 通过 `激活码 + LineID` 确定数据归属

**示例**:
```
客户端登录了3个激活码：ABC123, DEF456, GHI789

检测到本地Line账号：
- @line001 → 通过 ABC123 上报 → 归属分组1
- @line002 → 通过 DEF456 上报 → 归属分组2
- @line003 → 通过 ABC123 上报 → 归属分组1

进线数据：
- @line001收到进线 → 通过 ABC123 上报 → 分组1的进线数据
- @line002收到进线 → 通过 DEF456 上报 → 分组2的进线数据
```

**WebSocket消息格式**:
```json
{
  "type": "account_sync",
  "activation_code": "ABC123",      // 指定归属哪个分组
  "data": {
    "line_id": "@line001",
    "display_name": "张三",
    "platform_type": "line"
  }
}
```

---

## 📊 数据隔离规则

### 管理员
```sql
-- 查看所有数据，无过滤
SELECT * FROM line_accounts;
```

### 普通用户
```sql
-- 只查看自己创建的分组的数据
SELECT * FROM line_accounts la
JOIN groups g ON la.group_id = g.id
WHERE g.created_by = {current_user_id};
```

### 子账号
```sql
-- 只查看自己分组的数据
SELECT * FROM line_accounts
WHERE group_id = {current_group_id};
```
