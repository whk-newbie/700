# è¿›çº¿ç»Ÿè®¡ä¸å»é‡é€»è¾‘

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¥æœŸ**: 2025-12-21
> **è¯´æ˜**: è¿›çº¿æ•°æ®çš„ç»Ÿè®¡æ–¹å¼å’Œå»é‡åˆ¤æ–­é€»è¾‘

---

## ğŸ“Š è¿›çº¿æ•°æ®ç»Ÿè®¡

### ç»Ÿè®¡ç»´åº¦

#### 1. åˆ†ç»„çº§åˆ«ç»Ÿè®¡ï¼ˆçº¿ç´¢åˆ—è¡¨ï¼‰
- **å½“æ—¥è¿›çº¿**: è¯¥åˆ†ç»„ä¸‹æ‰€æœ‰Lineè´¦å·çš„å½“æ—¥è¿›çº¿æ€»æ•°
- **æ€»è¿›çº¿**: è¯¥åˆ†ç»„ä¸‹æ‰€æœ‰Lineè´¦å·çš„å†å²æ€»è¿›çº¿æ•°
- **é‡å¤è¿›çº¿**: è¯¥åˆ†ç»„ä¸‹æ‰€æœ‰è¢«åˆ¤å®šä¸ºé‡å¤çš„è¿›çº¿æ•°

#### 2. Lineè´¦å·çº§åˆ«ç»Ÿè®¡ï¼ˆå±•å¼€åï¼‰
- **å½“æ—¥è¿›çº¿**: è¯¥Lineè´¦å·ä»Šæ—¥çš„è¿›çº¿æ•°
- **æ€»è¿›çº¿**: è¯¥Lineè´¦å·çš„å†å²æ€»è¿›çº¿æ•°
- **é‡å¤è¿›çº¿**: è¯¥Lineè´¦å·çš„é‡å¤è¿›çº¿æ•°

---

## ğŸ”„ è¿›çº¿æµç¨‹

### å®Œæ•´æµç¨‹

```
1. Windowså®¢æˆ·ç«¯æ£€æµ‹åˆ°Lineè´¦å·æ”¶åˆ°æ–°å¥½å‹ç”³è¯·
   â†“
2. å®¢æˆ·ç«¯é€šè¿‡WebSocketä¸ŠæŠ¥è¿›çº¿æ•°æ®
   {
     "activation_code": "ABC123",
     "line_account_id": "@line001",
     "incoming_line_id": "U123456789",
     "display_name": "å¼ ä¸‰",  // å¯é€‰
     "timestamp": "2025-12-21 10:30:00"
   }
   â†“
3. æœåŠ¡å™¨æ¥æ”¶æ•°æ®
   - é€šè¿‡ activation_code æ‰¾åˆ°åˆ†ç»„
   - é€šè¿‡ activation_code + line_account_id æ‰¾åˆ°Lineè´¦å·è®°å½•
   â†“
4. æ‰§è¡Œå»é‡åˆ¤æ–­
   - è·å–è¯¥åˆ†ç»„çš„å»é‡èŒƒå›´è®¾ç½®
   - æ ¹æ®å»é‡èŒƒå›´æ£€æŸ¥åº•åº“
   â†“
5. è®°å½•è¿›çº¿æ—¥å¿—
   - æ’å…¥ incoming_logs è¡¨
   - æ ‡è®° is_duplicate å­—æ®µ
   â†“
6. æ›´æ–°ç»Ÿè®¡æ•°æ®
   - æ›´æ–°å½“æ—¥è¿›çº¿æ•°
   - æ›´æ–°æ€»è¿›çº¿æ•°
   - æ›´æ–°é‡å¤è¿›çº¿æ•°
   â†“
7. æ·»åŠ åˆ°åº•åº“ï¼ˆå¦‚æœä¸é‡å¤ï¼‰
   - æ’å…¥ contact_pool è¡¨
   â†“
8. æ¨é€å®æ—¶æ›´æ–°
   - WebSocketæ¨é€åˆ°å‰ç«¯
   - æ›´æ–°çº¿ç´¢åˆ—è¡¨çš„ç»Ÿè®¡æ•°æ®
```

---

## ğŸ¯ å»é‡é€»è¾‘è¯¦è§£

### ä¸¤ç§å»é‡èŒƒå›´

#### 1. å½“å‰æ¿€æ´»ç ï¼ˆæœ¬åˆ†ç»„å»é‡ï¼‰

**åˆ¤æ–­é€»è¾‘**:
```python
def check_duplicate_current(group_id, incoming_line_id):
    """
    æ£€æŸ¥è¯¥LineIDæ˜¯å¦åœ¨å½“å‰åˆ†ç»„çš„åº•åº“ä¸­å­˜åœ¨
    """
    exists = ContactPool.query.filter_by(
        group_id=group_id,
        line_id=incoming_line_id
    ).first()
    
    return exists is not None
```

**åœºæ™¯ç¤ºä¾‹**:
```
åˆ†ç»„1ï¼ˆæ¿€æ´»ç ABC123ï¼‰è®¾ç½®ï¼šå½“å‰æ¿€æ´»ç å»é‡
åˆ†ç»„2ï¼ˆæ¿€æ´»ç DEF456ï¼‰è®¾ç½®ï¼šå½“å‰æ¿€æ´»ç å»é‡

è¿›çº¿æƒ…å†µï¼š
- åˆ†ç»„1æ”¶åˆ°è¿›çº¿ U123456 â†’ æ£€æŸ¥åˆ†ç»„1åº•åº“ â†’ ä¸å­˜åœ¨ â†’ æ–°å¢ï¼ˆä¸é‡å¤ï¼‰
- åˆ†ç»„2æ”¶åˆ°è¿›çº¿ U123456 â†’ æ£€æŸ¥åˆ†ç»„2åº•åº“ â†’ ä¸å­˜åœ¨ â†’ æ–°å¢ï¼ˆä¸é‡å¤ï¼‰

ç»“æœï¼šåŒä¸€ä¸ªå®¢æˆ·åœ¨ä¸åŒåˆ†ç»„ä¸­éƒ½ç®—æ–°å¢ï¼Œä¸ç®—é‡å¤
```

#### 2. å…¨å±€å»é‡

**åˆ¤æ–­é€»è¾‘**:
```python
def check_duplicate_global(incoming_line_id):
    """
    æ£€æŸ¥è¯¥LineIDæ˜¯å¦åœ¨å…¨å±€åº•åº“ä¸­å­˜åœ¨
    """
    exists = ContactPool.query.filter_by(
        line_id=incoming_line_id
    ).first()
    
    return exists is not None
```

**åœºæ™¯ç¤ºä¾‹**:
```
åˆ†ç»„1ï¼ˆæ¿€æ´»ç ABC123ï¼‰è®¾ç½®ï¼šå…¨å±€å»é‡
åˆ†ç»„2ï¼ˆæ¿€æ´»ç DEF456ï¼‰è®¾ç½®ï¼šå…¨å±€å»é‡

è¿›çº¿æƒ…å†µï¼š
- åˆ†ç»„1æ”¶åˆ°è¿›çº¿ U123456 â†’ æ£€æŸ¥å…¨å±€åº•åº“ â†’ ä¸å­˜åœ¨ â†’ æ–°å¢ï¼ˆä¸é‡å¤ï¼‰
- åˆ†ç»„2æ”¶åˆ°è¿›çº¿ U123456 â†’ æ£€æŸ¥å…¨å±€åº•åº“ â†’ å·²å­˜åœ¨ â†’ æ ‡è®°é‡å¤ï¼ˆé‡å¤ï¼‰

ç»“æœï¼šåŒä¸€ä¸ªå®¢æˆ·åªåœ¨ç¬¬ä¸€ä¸ªåˆ†ç»„ä¸­ç®—æ–°å¢ï¼Œå…¶ä»–åˆ†ç»„ç®—é‡å¤
```

---

## ğŸ“‹ å®¢æˆ·åˆ—è¡¨ï¼ˆè¿›çº¿æ—¥å¿—ï¼‰

### å®¢æˆ·åˆ—è¡¨ = å…¨å±€å»é‡çš„è¿›çº¿æ—¥å¿—

**æ ¸å¿ƒæ¦‚å¿µ**:
- å®¢æˆ·åˆ—è¡¨å¯ä»¥çœ‹ä½œä¸€ä¸ªè¿›çº¿æ—¥å¿—
- å®¢æˆ·åˆ—è¡¨å§‹ç»ˆä½¿ç”¨å…¨å±€å»é‡
- ä¸ç®¡åˆ†ç»„çš„å»é‡èŒƒå›´è®¾ç½®å¦‚ä½•ï¼Œå®¢æˆ·åˆ—è¡¨éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„

**ç¤ºä¾‹**:
```
åˆ†ç»„1ï¼ˆå»é‡èŒƒå›´ï¼šå½“å‰æ¿€æ´»ç ï¼‰æ”¶åˆ°è¿›çº¿ U123456
åˆ†ç»„2ï¼ˆå»é‡èŒƒå›´ï¼šå½“å‰æ¿€æ´»ç ï¼‰æ”¶åˆ°è¿›çº¿ U123456
åˆ†ç»„3ï¼ˆå»é‡èŒƒå›´ï¼šå…¨å±€ï¼‰æ”¶åˆ°è¿›çº¿ U123456

çº¿ç´¢åˆ—è¡¨ç»Ÿè®¡ï¼š
- åˆ†ç»„1ï¼šæ–°å¢1ï¼ˆå› ä¸ºæœ¬åˆ†ç»„é¦–æ¬¡å‡ºç°ï¼‰
- åˆ†ç»„2ï¼šæ–°å¢1ï¼ˆå› ä¸ºæœ¬åˆ†ç»„é¦–æ¬¡å‡ºç°ï¼‰
- åˆ†ç»„3ï¼šé‡å¤1ï¼ˆå› ä¸ºå…¨å±€å·²å­˜åœ¨ï¼‰

å®¢æˆ·åˆ—è¡¨ï¼ˆå…¨å±€å»é‡ï¼‰ï¼š
- åªæ˜¾ç¤º1æ¡å®¢æˆ·è®°å½•ï¼ˆU123456ï¼‰
- å®¢æˆ·ç±»å‹ï¼šæ–°å¢çº¿ç´¢-å®æ—¶
- æ‰€å±åˆ†ç»„ï¼šåˆ†ç»„1ï¼ˆç¬¬ä¸€ä¸ªæ”¶åˆ°çš„åˆ†ç»„ï¼‰
```

### å®¢æˆ·ç±»å‹åˆ¤æ–­

- **æ–°å¢çº¿ç´¢-å®æ—¶**: å…¨å±€é¦–æ¬¡å‡ºç°çš„å®¢æˆ·ï¼Œå®æ—¶ä¸ŠæŠ¥
- **æ–°å¢çº¿ç´¢-è¡¥å½•**: å…¨å±€é¦–æ¬¡å‡ºç°çš„å®¢æˆ·ï¼Œåè¡¥å½•å…¥
- **æ–°å¢çº¿ç´¢-é‡å¤**: å…¨å±€å·²å­˜åœ¨çš„å®¢æˆ·ï¼Œå†æ¬¡è¿›çº¿ï¼ˆå®æ—¶ï¼‰
- **æ–°å¢çº¿ç´¢-å¯¼å…¥é‡å¤**: å¯¼å…¥æ—¶å‘ç°å…¨å±€å·²å­˜åœ¨çš„å®¢æˆ·

---

## ğŸ“ˆ ç»Ÿè®¡æ•°æ®è®¡ç®—

### å½“æ—¥è¿›çº¿è®¡ç®—

**é‡ç½®æ—¶é—´**: æ¯ä¸ªåˆ†ç»„æœ‰ç‹¬ç«‹çš„ç½®é›¶æ—¶é—´ï¼ˆå¦‚09:00:00ï¼‰

**è®¡ç®—é€»è¾‘**:
```python
def get_today_incoming_count(group_id):
    """
    è®¡ç®—ä»Šæ—¥è¿›çº¿æ•°
    """
    group = Group.query.get(group_id)
    reset_time = group.reset_time  # å¦‚ "09:00:00"
    
    # è®¡ç®—ä»Šæ—¥é‡ç½®æ—¶é—´ç‚¹
    today_reset = datetime.combine(date.today(), reset_time)
    
    # å¦‚æœå½“å‰æ—¶é—´æ—©äºé‡ç½®æ—¶é—´ï¼Œåˆ™é‡ç½®æ—¶é—´ç‚¹æ˜¯æ˜¨å¤©
    if datetime.now() < today_reset:
        today_reset = today_reset - timedelta(days=1)
    
    # ç»Ÿè®¡é‡ç½®æ—¶é—´åçš„è¿›çº¿æ•°
    count = IncomingLog.query.join(LineAccount).filter(
        LineAccount.group_id == group_id,
        IncomingLog.incoming_time >= today_reset
    ).count()
    
    return count
```

### é‡å¤è¿›çº¿åˆ¤æ–­

```python
def record_incoming(activation_code, line_account_line_id, incoming_line_id):
    """
    è®°å½•è¿›çº¿å¹¶åˆ¤æ–­æ˜¯å¦é‡å¤
    """
    # 1. æ‰¾åˆ°åˆ†ç»„å’ŒLineè´¦å·
    group = Group.query.filter_by(activation_code=activation_code).first()
    line_account = LineAccount.query.filter_by(
        group_id=group.id,
        line_id=line_account_line_id
    ).first()
    
    # 2. æ ¹æ®å»é‡èŒƒå›´åˆ¤æ–­æ˜¯å¦é‡å¤
    if group.dedup_scope == 'current':
        # åªæ£€æŸ¥æœ¬åˆ†ç»„åº•åº“
        is_duplicate = ContactPool.query.filter_by(
            group_id=group.id,
            line_id=incoming_line_id
        ).first() is not None
    else:  # 'global'
        # æ£€æŸ¥å…¨å±€åº•åº“
        is_duplicate = ContactPool.query.filter_by(
            line_id=incoming_line_id
        ).first() is not None
    
    # 3. è®°å½•è¿›çº¿æ—¥å¿—
    log = IncomingLog(
        line_account_id=line_account.id,
        incoming_line_id=incoming_line_id,
        is_duplicate=is_duplicate,
        incoming_time=datetime.now()
    )
    db.session.add(log)
    
    # 4. å¦‚æœä¸é‡å¤ï¼Œæ·»åŠ åˆ°åº•åº“
    if not is_duplicate:
        contact = ContactPool(
            group_id=group.id,
            line_id=incoming_line_id,
            source_type='platform',
            platform_type=line_account.platform_type
        )
        db.session.add(contact)
    
    db.session.commit()
    
    return is_duplicate
```

---

## ğŸ’¾ ç›¸å…³æ•°æ®åº“è¡¨

### incoming_logs è¡¨ï¼ˆè¿›çº¿è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE incoming_logs (
    id BIGSERIAL PRIMARY KEY,
    line_account_id INTEGER NOT NULL REFERENCES line_accounts(id) ON DELETE CASCADE,
    
    -- è¿›çº¿ä¿¡æ¯
    incoming_line_id VARCHAR(100) NOT NULL,            -- è¿›çº¿å®¢æˆ·çš„Line User ID
    incoming_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- è¿›çº¿æ—¶é—´
    
    -- å»é‡æ ‡è®°
    is_duplicate BOOLEAN DEFAULT FALSE,                -- æ˜¯å¦é‡å¤
    
    -- ç´¢å¼•
    INDEX idx_line_account (line_account_id, incoming_time DESC),
    INDEX idx_incoming_line_id (incoming_line_id),
    INDEX idx_incoming_time (incoming_time),
    INDEX idx_duplicate (is_duplicate)
);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE incoming_logs_2025_01 PARTITION OF incoming_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

## ğŸ”” å®æ—¶æ¨é€

### WebSocketæ¨é€è¿›çº¿æ›´æ–°

å½“æœ‰æ–°è¿›çº¿æ—¶ï¼ŒæœåŠ¡å™¨æ¨é€æ›´æ–°åˆ°å‰ç«¯ï¼š

```json
{
  "type": "incoming_update",
  "data": {
    "group_id": 1,
    "line_account_id": 123,
    "today_incoming": 121,
    "total_incoming": 5001,
    "duplicate_incoming": 151,
    "is_duplicate": false
  }
}
```

å‰ç«¯æ¥æ”¶åï¼š
- æ›´æ–°çº¿ç´¢åˆ—è¡¨å¯¹åº”åˆ†ç»„çš„ç»Ÿè®¡æ•°æ®
- å¦‚æœå±•å¼€äº†è¯¥åˆ†ç»„ï¼Œæ›´æ–°å¯¹åº”Lineè´¦å·çš„ç»Ÿè®¡
- æ•°å­—å˜åŒ–æ—¶æ·»åŠ åŠ¨ç”»æ•ˆæœ

---

## âœ… å·²ç¡®è®¤å†…å®¹

- [x] è¿›çº¿ç»Ÿè®¡ç»´åº¦ï¼šåˆ†ç»„çº§åˆ« + Lineè´¦å·çº§åˆ«
- [x] ç»Ÿè®¡å­—æ®µï¼šå½“æ—¥è¿›çº¿ã€æ€»è¿›çº¿ã€é‡å¤è¿›çº¿
- [x] å»é‡èŒƒå›´ï¼šå½“å‰æ¿€æ´»ç ã€å…¨å±€ä¸¤ç§
- [x] å®¢æˆ·åˆ—è¡¨ä½¿ç”¨å…¨å±€å»é‡
- [x] ç½®é›¶æ—¶é—´ï¼šæ¯ä¸ªåˆ†ç»„ç‹¬ç«‹è®¾ç½®
- [x] æ•°æ®æµç¨‹ï¼šä¸ŠæŠ¥ â†’ å»é‡åˆ¤æ–­ â†’ è®°å½• â†’ ç»Ÿè®¡ â†’ æ¨é€


