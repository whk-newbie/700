# Line账号分组管理系统 - 需求方案

> **版本**: v2.0
> **更新日期**: 2025-12-21
> **说明**: 基于CEO SCRM系统重新设计的分组管理需求方案

---

## 📋 项目概述

### 核心功能
Line账号分组管理系统，主要用于管理多个分组（普通用户），每个分组包含多个Line账号，支持在线监控、进线统计、去重管理等功能。

### 用户角色
- **管理员**: 管理所有分组、配置系统参数
- **普通用户（分组）**: 每个分组对应一个普通用户，拥有独立的激活码
- **子用户**: 归属于某个分组，只能查看分配给自己的Line账号

---

## 🎯 分组列表页面（核心页面）

### 页面路径
`/group-list` 或 `/activation-code-list`

### 页面说明
此页面展示所有分组（普通用户）的列表，每个分组对应一个激活码，用于Windows客户端登录。

---

## 📊 列表字段定义

### 1. 激活码
- **字段名**: `activation_code`
- **类型**: `VARCHAR(32)`
- **说明**: 每个分组的唯一标识码，用于Windows客户端登录
- **显示方式**: 文字显示 + 复制按钮
- **特性**: 
  - 自动生成
  - 可重新生成
  - 唯一性约束

**示例**:
```
TF6AwzwT [📋复制图标]
```

---

### 2. 占用/分配
- **字段名**: `used_count` / `allocated_count`
- **类型**: `INTEGER` / `INTEGER`
- **说明**: 
  - **占用数**: 当前已登录使用的Line账号数量
  - **分配数**: 该分组下总共分配的Line账号数量上限（0或null表示不限制）
- **显示方式**: `占用数/分配数`

**示例**:
```
6/不限制
18/30
0/100
```

**计算逻辑**:
```python
# 占用数 = 当前在线的Line账号数
used_count = count(line_accounts WHERE group_id = X AND status = 'online')

# 分配数 = 该分组的账号上限配置
allocated_count = groups.account_limit  # null或0表示不限制
```

---

### 3. 在线/总账号
- **字段名**: `online_count` / `total_count`
- **类型**: `INTEGER` / `INTEGER`
- **说明**: 
  - **在线数**: 当前在线的Line账号数量
  - **总账号**: 该分组下所有Line账号总数
- **显示方式**: `在线数/总账号数`

**示例**:
```
6/6    (全部在线)
9/17   (部分在线)
0/0    (无账号)
```

**计算逻辑**:
```python
# 在线数
online_count = count(line_accounts WHERE group_id = X AND online_status = 'online')

# 总账号
total_count = count(line_accounts WHERE group_id = X AND deleted_at IS NULL)
```

---

### 4. 启用状态
- **字段名**: `is_active`
- **类型**: `BOOLEAN`
- **说明**: 该分组是否启用（禁用后Windows客户端无法使用该激活码登录）
- **显示方式**: 文字或标签
- **可选值**:
  - `正常` (is_active = true)
  - `已禁用` (is_active = false)

**示例**:
```
正常        (绿色标签)
已禁用      (灰色标签)
```

---

### 5. 备注信息
- **字段名**: `remark`
- **类型**: `VARCHAR(255)`
- **说明**: 分组的备注信息，管理员可编辑
- **显示方式**: 文字显示 + 编辑图标

**示例**:
```
德华2 [✏️编辑图标]
大鱼普通号 [✏️编辑图标]
战狼 [✏️编辑图标]
```

**交互**:
- 点击编辑图标，弹出输入框快速修改
- 支持内联编辑

---

### 6. 说明
- **字段名**: `description`
- **类型**: `TEXT`
- **说明**: 分组的详细说明信息（可选）
- **显示方式**: 图标按钮，点击查看详情

**示例**:
```
[ℹ️说明图标]  (有说明时显示)
-             (无说明时显示)
```

**交互**:
- 点击图标，弹出气泡或弹窗显示完整说明
- 可在编辑页面修改

---

### 7. 去重范围
- **字段名**: `dedup_scope`
- **类型**: `VARCHAR(20)`
- **说明**: 进线去重的范围设置
- **可选值**:
  - `当前激活码` - 仅在该分组内去重
  - `全局` - 跨所有分组去重

**示例**:
```
当前激活码
全局
```

**业务逻辑**:
- 当新进线时，根据去重范围判断该LineID是否已存在于底库
- **当前激活码**: 只检查本分组的底库
- **全局**: 检查所有分组的底库
- 影响"重复进线"的统计
- **客户列表始终使用全局去重**（作为进线日志）

---

### 8. 创建时间/最近登录
- **字段名**: `created_at` / `last_login_at`
- **类型**: `TIMESTAMP` / `TIMESTAMP`
- **说明**: 
  - **创建时间**: 分组创建时间
  - **最近登录**: Windows客户端最后一次使用该激活码登录的时间
- **显示方式**: 两行显示

**示例**:
```
2025-12-21 18:30:52
2025-12-21 20:15:30
```

或单行显示：
```
2025-12-21 18:30:52 ~ (未登录)
2025-12-20 18:22:21 ~ 2025-12-20 22:14:33
```

---

### 9. 置零时间
- **字段名**: `reset_time`
- **类型**: `TIME`
- **说明**: 每日进线数据重置的时间点（如每天09:00:00重置）
- **显示方式**: 时间格式 HH:mm:ss

**示例**:
```
09:00:00
00:00:00
12:00:00
```

**业务逻辑**:
- 系统在指定时间自动将该分组下所有Line账号的"当日进线数"清零
- 可针对不同分组设置不同的重置时间

---

### 10. 分组
- **字段名**: `group_name` 或 `category`
- **类型**: `VARCHAR(50)`
- **说明**: 分组归类名称（用于二级分类，如"默认分组"、"VIP分组"等）
- **显示方式**: 标签或文字

**示例**:
```
默认分组
VIP分组
测试分组
```

**说明**:
- 这是对"分组"的再分类（分组的分组）
- 如果不需要二级分类，可统一显示"默认分组"

---

### 11. 操作
- **字段名**: -
- **类型**: 按钮组
- **说明**: 对该分组的操作按钮
- **保留的操作**:
  - **查看**: 查看该分组的详细信息和Line账号列表
  - **禁用**: 禁用该分组（禁用后激活码无法登录）

**示例**:
```
[👁️ 查看] [🚫 禁用]
```

**交互逻辑**:
- **查看**: 跳转到分组详情页 `/group-detail/{id}`
- **禁用**: 
  - 弹出确认对话框："确定要禁用该分组吗？禁用后Windows客户端将无法使用该激活码登录。"
  - 确认后，设置 `is_active = false`
  - 如果已禁用，按钮文字变为"启用"

---

## 🔍 筛选功能

### 筛选条件

#### 1. 时间范围筛选
- **字段**: `created_at` 或 `last_login_at`
- **类型**: 日期范围选择器
- **显示**: 
  ```
  [开始时间] ~ [截止时间]
  ```

#### 2. 激活码搜索
- **字段**: `activation_code`
- **类型**: 文本输入框
- **占位符**: "请输入激活码"
- **匹配方式**: 模糊搜索

#### 3. 备注信息搜索
- **字段**: `remark`
- **类型**: 文本输入框
- **占位符**: "请输入备注信息"
- **匹配方式**: 模糊搜索

#### 4. 启用状态筛选
- **字段**: `is_active`
- **类型**: 下拉选择
- **选项**:
  - 全部
  - 正常
  - 已禁用

#### 5. 去重范围筛选（可选）
- **字段**: `dedup_scope`
- **类型**: 下拉选择
- **选项**:
  - 全部
  - 当前激活码
  - 全局
  - 自定义分组

### 筛选操作按钮
```
[🔍 搜索]  [🔄 重选]
```

- **搜索**: 应用筛选条件
- **重选**: 清空所有筛选条件，恢复默认状态

---

## ⚙️ 激活码管理功能

### 分组管理（激活码分组）
- **按钮位置**: 列表上方
- **按钮文字**: `激活码分组 ▼`
- **功能**: 点击展开下拉菜单，显示所有二级分组（如"默认分组"、"VIP分组"）
- **交互**:
  - 选择某个分组，筛选显示该分组下的所有激活码
  - 可新建分组、重命名分组、删除分组

### 新增激活码
- **按钮位置**: 列表上方
- **按钮文字**: `➕ 新增激活码`
- **功能**: 创建新的分组（普通用户）
- **交互**: 弹出对话框，填写以下信息
  - 备注信息（必填）
  - 说明（可选）
  - 分配数（账号上限，可选）
  - 置零时间（默认09:00:00）
  - 去重范围（默认"当前激活码"）
  - 分组归类（选择或新建）
- **提交后**: 
  - 自动生成激活码
  - 默认启用状态

---

## 📦 批量操作功能

### 批量操作按钮
- **按钮位置**: 列表上方
- **按钮文字**: `📦 批量操作 ▼`
- **功能**: 对选中的多个分组进行批量操作

### 可批量操作项

#### 1. 批量禁用
- 禁用选中的所有分组
- 弹出确认："确定要禁用选中的X个分组吗？"

#### 2. 批量启用
- 启用选中的所有分组

#### 3. 批量修改置零时间
- 弹出时间选择器
- 应用到所有选中的分组

#### 4. 批量修改去重范围
- 弹出下拉选择（当前激活码 / 全局）
- 应用到所有选中的分组

#### 5. 批量分组归类
- 选择或新建分组归类
- 将选中的分组移动到该归类

#### 6. 批量删除（危险操作）
- 弹出二次确认
- 删除选中的分组及其下所有Line账号

### 选择逻辑
- 表格第一列为复选框
- 表头复选框：全选/取消全选
- 每行复选框：单选该分组
- 底部显示已选数量：`已选 3 项`

---

## 📱 列表页面布局

### 页面结构
```
┌─────────────────────────────────────────────────────────┐
│  📋 分组列表（激活码列表）                                │
│  说明：所有激活码会统一归类至默认分组，如需区分，请自定义分组  │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  [筛选区域]                                               │
│  ┌──────────┬──────────┬──────────┬──────────┐          │
│  │开始时间～│ 激活码   │ 备注信息 │ 启用状态 │          │
│  │截止时间  │          │          │          │          │
│  └──────────┴──────────┴──────────┴──────────┘          │
│                                                           │
│  [🔍 搜索]  [🔄 重选]                                     │
│                                                           │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  [操作按钮区域]                                           │
│  [激活码分组 ▼] [➕ 新增激活码] [📦 批量操作 ▼]            │
│                                                           │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  [数据表格]                                               │
│  ┌──┬────────┬──────┬──────┬────┬────┬───┬────┬───┐    │
│  │☑│激活码  │占用  │在线  │状态│备注│...│操作│   │    │
│  ├──┼────────┼──────┼──────┼────┼────┼───┼────┼───┤    │
│  │☐│TF6AwzwT│0/不限│0/0   │正常│德华│...│查看│禁用│    │
│  │☐│vv2NMw8J│0/不限│0/0   │正常│... │...│查看│禁用│    │
│  │☐│y2E7uw29│6/100 │6/6   │正常│... │...│查看│禁用│    │
│  └──┴────────┴──────┴──────┴────┴────┴───┴────┴───┘    │
│                                                           │
│  [单页合计]  41/0    41/53                                │
│                                                           │
│  共 38 条    [10条/页 ▼]  [◀] [1][2][3][4] [▶]          │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 💾 数据库表结构（初步设计）

### groups 表（分组/普通用户表）
```sql
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    
    -- 激活码
    activation_code VARCHAR(32) UNIQUE NOT NULL,
    
    -- 账号限制
    account_limit INTEGER DEFAULT NULL,              -- null或0表示不限制
    
    -- 启用状态
    is_active BOOLEAN DEFAULT TRUE,
    
    -- 备注和说明
    remark VARCHAR(255),
    description TEXT,
    
    -- 去重范围
    dedup_scope VARCHAR(20) DEFAULT 'current',       -- 'current', 'global', 'custom'
    dedup_custom_groups JSONB,                       -- 自定义去重分组ID列表
    
    -- 时间相关
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,                         -- 最近登录时间
    reset_time TIME DEFAULT '09:00:00',              -- 置零时间
    
    -- 分组归类
    category VARCHAR(50) DEFAULT '默认分组',
    
    -- 索引
    INDEX idx_activation_code (activation_code),
    INDEX idx_category (category),
    INDEX idx_is_active (is_active)
);
```

### line_accounts 表（Line账号表）
```sql
CREATE TABLE line_accounts (
    id SERIAL PRIMARY KEY,
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- Line账号信息
    line_id VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(100),
    
    -- 在线状态
    online_status VARCHAR(10) DEFAULT 'offline',     -- 'online', 'offline'
    last_online_time TIMESTAMP,
    
    -- 软删除
    deleted_at TIMESTAMP,
    
    -- 索引
    INDEX idx_group_id (group_id),
    INDEX idx_online_status (online_status),
    INDEX idx_deleted (deleted_at)
);
```

---

## 🔄 下一步需要确认的内容

1. **Line账号列表页面** - 点击"查看"后进入的页面需求
2. **子用户管理** - 子用户与分组的关系
3. **进线统计** - 进线数据的展示和统计方式
4. **Windows客户端交互** - 客户端与服务器的数据交互协议
5. **去重逻辑详细说明** - 如何判断重复进线
6. **看盘页面** - 实时监控页面的需求

---

## ✅ 当前已确认需求

- [x] 分组列表页面字段定义
- [x] 筛选功能需求
- [x] 激活码管理功能
- [x] 批量操作功能
- [x] 导出表格功能
- [ ] 分组详情页面
- [ ] Line账号管理
- [ ] 子用户管理
- [ ] 进线统计
- [ ] 实时监控


