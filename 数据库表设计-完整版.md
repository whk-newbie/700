# æ•°æ®åº“è¡¨è®¾è®¡ - å®Œæ•´ç‰ˆ

> **ç‰ˆæœ¬**: v2.0
> **æ›´æ–°æ—¥æœŸ**: 2025-12-21
> **æŠ€æœ¯æ ˆ**: Go + Vue3 + Element Plus + PostgreSQL + Redis

---

## ğŸ“‹ æ•°æ®åº“è®¾è®¡æ¦‚è¿°

### æ ¸å¿ƒè¡¨ç»“æ„ï¼ˆ14å¼ è¡¨ï¼‰

1. **users** - ç”¨æˆ·è¡¨ï¼ˆç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ï¼‰
2. **groups** - åˆ†ç»„è¡¨ï¼ˆæ¿€æ´»ç /å­è´¦å·ï¼‰
3. **line_accounts** - Lineè´¦å·è¡¨
4. **line_account_stats** - Lineè´¦å·ç»Ÿè®¡è¡¨ï¼ˆå¢é‡æ›´æ–°ï¼‰
5. **group_stats** - åˆ†ç»„ç»Ÿè®¡è¡¨ï¼ˆå¢é‡æ›´æ–°ï¼‰
6. **incoming_logs** - è¿›çº¿è®°å½•è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
7. **contact_pool** - åŸå§‹è”ç³»äººåº•åº“è¡¨
8. **customers** - å®¢æˆ·è¡¨
9. **follow_up_records** - è·Ÿè¿›è®°å½•è¡¨
10. **account_status_logs** - è´¦å·çŠ¶æ€æ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
11. **import_batches** - å¯¼å…¥æ‰¹æ¬¡è¡¨
12. **llm_configs** - å¤§æ¨¡å‹é…ç½®è¡¨
13. **llm_prompt_templates** - Promptæ¨¡æ¿è¡¨
14. **llm_call_logs** - å¤§æ¨¡å‹è°ƒç”¨è®°å½•è¡¨

---

## ğŸ—„ï¸ è¯¦ç»†è¡¨ç»“æ„

### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**è¯´æ˜**: å­˜å‚¨ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    
    -- è§’è‰²
    role VARCHAR(20) NOT NULL DEFAULT 'user',          -- 'admin' | 'user'
    
    -- åˆ†ç»„é™åˆ¶
    max_groups INTEGER DEFAULT NULL,                   -- æœ€å¤§å¯åˆ›å»ºåˆ†ç»„æ•°ï¼ˆNULL=æ— é™åˆ¶ï¼‰
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    
    -- åˆ›å»ºä¿¡æ¯
    created_by INTEGER REFERENCES users(id),           -- åˆ›å»ºè€…ï¼ˆç®¡ç†å‘˜åˆ›å»ºæ™®é€šç”¨æˆ·ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_role CHECK (role IN ('admin', 'user'))
);

-- ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_deleted ON users(deleted_at);

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨ï¼šç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·';
COMMENT ON COLUMN users.role IS 'è§’è‰²ï¼šadmin=ç®¡ç†å‘˜, user=æ™®é€šç”¨æˆ·';
COMMENT ON COLUMN users.max_groups IS 'æœ€å¤§å¯åˆ›å»ºåˆ†ç»„æ•°ï¼šNULLæˆ–0è¡¨ç¤ºæ— é™åˆ¶ï¼Œå¤§äº0è¡¨ç¤ºå…·ä½“é™åˆ¶æ•°é‡';
```

---

### 2. groupsï¼ˆåˆ†ç»„è¡¨/æ¿€æ´»ç è¡¨/å­è´¦å·è¡¨ï¼‰

**è¯´æ˜**: æ¯ä¸ªåˆ†ç»„å¯¹åº”ä¸€ä¸ªæ¿€æ´»ç ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå­è´¦å·

```sql
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    
    -- æ‰€å±ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·åˆ›å»ºåˆ†ç»„ï¼‰
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- æ¿€æ´»ç ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    activation_code VARCHAR(32) UNIQUE NOT NULL,
    
    -- è´¦å·é™åˆ¶
    account_limit INTEGER DEFAULT NULL,                -- nullæˆ–0è¡¨ç¤ºä¸é™åˆ¶
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,                    -- æ˜¯å¦å¯ç”¨
    
    -- åˆ†ç»„ä¿¡æ¯
    remark VARCHAR(255),                               -- å¤‡æ³¨ä¿¡æ¯
    description TEXT,                                  -- è¯¦ç»†è¯´æ˜
    category VARCHAR(50) DEFAULT 'é»˜è®¤åˆ†ç»„',           -- åˆ†ç»„å½’ç±»ï¼ˆäºŒçº§åˆ†ç±»ï¼‰
    
    -- å»é‡è®¾ç½®
    dedup_scope VARCHAR(20) DEFAULT 'current',         -- 'current' | 'global'
    
    -- æ—¶é—´è®¾ç½®
    reset_time TIME DEFAULT '09:00:00',                -- æ¯æ—¥é‡ç½®æ—¶é—´
    
    -- å­è´¦å·ç™»å½•ï¼ˆå¯é€‰å¯†ç ï¼‰
    login_password VARCHAR(255),                       -- å­è´¦å·ç™»å½•å¯†ç ï¼ˆå¯ä¸ºç©ºï¼‰
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,                           -- Windowså®¢æˆ·ç«¯æœ€åç™»å½•æ—¶é—´
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_dedup_scope CHECK (dedup_scope IN ('current', 'global'))
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_groups_activation_code ON groups(activation_code) WHERE deleted_at IS NULL;
CREATE INDEX idx_groups_user_id ON groups(user_id);
CREATE INDEX idx_groups_category ON groups(category);
CREATE INDEX idx_groups_is_active ON groups(is_active);
CREATE INDEX idx_groups_deleted ON groups(deleted_at);

-- æ³¨é‡Š
COMMENT ON TABLE groups IS 'åˆ†ç»„è¡¨ï¼šæ¯ä¸ªåˆ†ç»„å¯¹åº”ä¸€ä¸ªæ¿€æ´»ç ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå­è´¦å·';
COMMENT ON COLUMN groups.activation_code IS 'Windowså®¢æˆ·ç«¯å’Œå­è´¦å·ç™»å½•ä½¿ç”¨çš„æ¿€æ´»ç ';
COMMENT ON COLUMN groups.dedup_scope IS 'å»é‡èŒƒå›´ï¼šcurrent=æœ¬åˆ†ç»„, global=å…¨å±€';
COMMENT ON COLUMN groups.login_password IS 'å­è´¦å·ç™»å½•å¯†ç ï¼Œä¸ºç©ºæ—¶åªéœ€æ¿€æ´»ç å³å¯ç™»å½•';
```

---

### 3. line_accountsï¼ˆLineè´¦å·è¡¨ï¼‰

**è¯´æ˜**: å­˜å‚¨æ‰€æœ‰Lineè´¦å·ä¿¡æ¯

```sql
CREATE TABLE line_accounts (
    id SERIAL PRIMARY KEY,
    
    -- æ‰€å±åˆ†ç»„
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    activation_code VARCHAR(32) NOT NULL,              -- å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿æŸ¥è¯¢
    
    -- å¹³å°ç±»å‹
    platform_type VARCHAR(20) NOT NULL DEFAULT 'line', -- 'line' | 'line_business'
    
    -- Lineè´¦å·ä¿¡æ¯
    line_id VARCHAR(100) NOT NULL,                     -- Line ID (å¦‚ @abc123 æˆ– dk36289)
    display_name VARCHAR(100),                         -- æ˜¾ç¤ºåç§°
    phone_number VARCHAR(20),                          -- ç»‘å®šæ‰‹æœºå·
    
    -- Lineèµ„æ–™
    profile_url VARCHAR(500),                          -- ä¸»é¡µåœ°å€
    avatar_url VARCHAR(500),                           -- å¤´åƒURL
    bio TEXT,                                          -- ä¸ªäººç®€ä»‹
    status_message VARCHAR(255),                       -- çŠ¶æ€æ¶ˆæ¯
    
    -- äºŒç»´ç 
    qr_code_path VARCHAR(255),                         -- äºŒç»´ç æ–‡ä»¶è·¯å¾„
    
    -- åœ¨çº¿çŠ¶æ€
    online_status VARCHAR(20) DEFAULT 'offline',       -- 'online' | 'user_logout' | 'abnormal_offline'
    last_active_at TIMESTAMP,                          -- æœ€åæ´»è·ƒæ—¶é—´
    last_online_time TIMESTAMP,                        -- æœ€ååœ¨çº¿æ—¶é—´
    
    -- ç™»å½•æ—¶é—´
    first_login_at TIMESTAMP,                          -- é¦–æ¬¡ç™»å½•æ—¶é—´
    
    -- å¤‡æ³¨
    account_remark TEXT,                               -- è´¦å·å¤‡æ³¨
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    deleted_by INTEGER REFERENCES users(id),
    
    -- çº¦æŸ
    CONSTRAINT check_platform_type CHECK (platform_type IN ('line', 'line_business')),
    CONSTRAINT check_online_status CHECK (online_status IN ('online', 'user_logout', 'abnormal_offline'))
);

-- å”¯ä¸€ç´¢å¼•ï¼šåŒä¸€åˆ†ç»„ä¸‹line_idå”¯ä¸€ï¼ˆè½¯åˆ é™¤åå¯é‡å¤ï¼‰
CREATE UNIQUE INDEX idx_line_accounts_unique ON line_accounts(group_id, line_id) WHERE deleted_at IS NULL;

-- å…¶ä»–ç´¢å¼•
CREATE INDEX idx_line_accounts_group_id ON line_accounts(group_id);
CREATE INDEX idx_line_accounts_activation_code ON line_accounts(activation_code);
CREATE INDEX idx_line_accounts_platform_type ON line_accounts(platform_type);
CREATE INDEX idx_line_accounts_online_status ON line_accounts(online_status);
CREATE INDEX idx_line_accounts_line_id ON line_accounts(line_id);
CREATE INDEX idx_line_accounts_deleted ON line_accounts(deleted_at);
CREATE INDEX idx_line_accounts_last_active ON line_accounts(last_active_at DESC);

-- æ³¨é‡Š
COMMENT ON TABLE line_accounts IS 'Lineè´¦å·è¡¨';
COMMENT ON COLUMN line_accounts.line_id IS 'Lineå®˜æ–¹IDï¼Œå¦‚ @abc123 æˆ– dk36289';
COMMENT ON COLUMN line_accounts.online_status IS 'åœ¨çº¿çŠ¶æ€ï¼šonline=åœ¨çº¿, user_logout=ä¸»åŠ¨é€€å‡º, abnormal_offline=å¼‚å¸¸ç¦»çº¿';
```

---

### 4. line_account_statsï¼ˆLineè´¦å·ç»Ÿè®¡è¡¨ï¼‰

**è¯´æ˜**: Lineè´¦å·çº§åˆ«çš„ç»Ÿè®¡æ•°æ®ï¼Œé‡‡ç”¨å¢é‡æ›´æ–°

```sql
CREATE TABLE line_account_stats (
    id SERIAL PRIMARY KEY,
    line_account_id INTEGER NOT NULL REFERENCES line_accounts(id) ON DELETE CASCADE,
    
    -- è¿›çº¿ç»Ÿè®¡
    today_incoming INTEGER DEFAULT 0,                  -- å½“æ—¥è¿›çº¿æ•°
    total_incoming INTEGER DEFAULT 0,                  -- æ€»è¿›çº¿æ•°
    duplicate_incoming INTEGER DEFAULT 0,              -- é‡å¤è¿›çº¿æ•°ï¼ˆæ€»è®¡ï¼‰
    today_duplicate INTEGER DEFAULT 0,                 -- å½“æ—¥é‡å¤è¿›çº¿æ•°
    
    -- é‡ç½®ä¿¡æ¯
    last_reset_date DATE,                              -- æœ€åé‡ç½®æ—¥æœŸ
    last_reset_time TIMESTAMP,                         -- æœ€åé‡ç½®æ—¶é—´æˆ³
    
    -- æ›´æ–°æ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT unique_line_account_stats UNIQUE(line_account_id)
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_line_account_stats_unique ON line_account_stats(line_account_id);

-- æ³¨é‡Š
COMMENT ON TABLE line_account_stats IS 'Lineè´¦å·ç»Ÿè®¡è¡¨ï¼ˆå¢é‡æ›´æ–°ï¼‰';
COMMENT ON COLUMN line_account_stats.today_incoming IS 'å½“æ—¥è¿›çº¿æ•°ï¼ˆä»é‡ç½®æ—¶é—´å¼€å§‹è®¡ç®—ï¼‰';
COMMENT ON COLUMN line_account_stats.total_incoming IS 'å†å²æ€»è¿›çº¿æ•°';
COMMENT ON COLUMN line_account_stats.duplicate_incoming IS 'æ€»é‡å¤è¿›çº¿æ•°';
COMMENT ON COLUMN line_account_stats.today_duplicate IS 'å½“æ—¥é‡å¤è¿›çº¿æ•°';
```

---

### 5. group_statsï¼ˆåˆ†ç»„ç»Ÿè®¡è¡¨ï¼‰

**è¯´æ˜**: åˆ†ç»„çº§åˆ«çš„ç»Ÿè®¡æ•°æ®ï¼Œé‡‡ç”¨å¢é‡æ›´æ–°

```sql
CREATE TABLE group_stats (
    id SERIAL PRIMARY KEY,
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- è´¦å·ç»Ÿè®¡
    total_accounts INTEGER DEFAULT 0,                  -- æ€»è´¦å·æ•°ï¼ˆæœªåˆ é™¤ï¼‰
    online_accounts INTEGER DEFAULT 0,                 -- åœ¨çº¿è´¦å·æ•°
    line_accounts INTEGER DEFAULT 0,                   -- Lineå¹³å°è´¦å·æ•°
    line_business_accounts INTEGER DEFAULT 0,          -- Line Businessè´¦å·æ•°
    
    -- è¿›çº¿ç»Ÿè®¡
    today_incoming INTEGER DEFAULT 0,                  -- å½“æ—¥è¿›çº¿æ•°
    total_incoming INTEGER DEFAULT 0,                  -- æ€»è¿›çº¿æ•°
    duplicate_incoming INTEGER DEFAULT 0,              -- é‡å¤è¿›çº¿æ•°ï¼ˆæ€»è®¡ï¼‰
    today_duplicate INTEGER DEFAULT 0,                 -- å½“æ—¥é‡å¤è¿›çº¿æ•°
    
    -- é‡ç½®ä¿¡æ¯
    last_reset_date DATE,                              -- æœ€åé‡ç½®æ—¥æœŸ
    last_reset_time TIMESTAMP,                         -- æœ€åé‡ç½®æ—¶é—´æˆ³
    
    -- æ›´æ–°æ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT unique_group_stats UNIQUE(group_id)
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_group_stats_unique ON group_stats(group_id);

-- æ³¨é‡Š
COMMENT ON TABLE group_stats IS 'åˆ†ç»„ç»Ÿè®¡è¡¨ï¼ˆå¢é‡æ›´æ–°ï¼‰';
COMMENT ON COLUMN group_stats.today_incoming IS 'å½“æ—¥è¿›çº¿æ•°ï¼ˆä»é‡ç½®æ—¶é—´å¼€å§‹è®¡ç®—ï¼‰';
```

---

### 6. incoming_logsï¼ˆè¿›çº¿è®°å½•è¡¨ï¼‰â­

**è¯´æ˜**: è®°å½•æ‰€æœ‰è¿›çº¿æ•°æ®ï¼ŒæŒ‰æœˆåˆ†åŒº

```sql
CREATE TABLE incoming_logs (
    id BIGSERIAL,
    
    -- å…³è”ä¿¡æ¯
    line_account_id INTEGER NOT NULL,                  -- å“ªä¸ªLineè´¦å·æ”¶åˆ°çš„è¿›çº¿
    group_id INTEGER NOT NULL,                         -- æ‰€å±åˆ†ç»„ï¼ˆå†—ä½™å­—æ®µï¼Œæ–¹ä¾¿åˆ†åŒºæŸ¥è¯¢ï¼‰
    
    -- è¿›çº¿ä¿¡æ¯
    incoming_line_id VARCHAR(100) NOT NULL,            -- è¿›çº¿å®¢æˆ·çš„Line User ID
    incoming_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- è¿›çº¿è¯¦æƒ…ï¼ˆå¯é€‰å­—æ®µï¼‰
    display_name VARCHAR(100),                         -- è¿›çº¿å®¢æˆ·æ˜¾ç¤ºåç§°
    avatar_url VARCHAR(500),                           -- è¿›çº¿å®¢æˆ·å¤´åƒ
    phone_number VARCHAR(20),                          -- è¿›çº¿å®¢æˆ·æ‰‹æœºå·
    
    -- å»é‡æ ‡è®°
    is_duplicate BOOLEAN DEFAULT FALSE,                -- æ˜¯å¦é‡å¤ï¼ˆæ ¹æ®å»é‡èŒƒå›´åˆ¤æ–­ï¼‰
    duplicate_scope VARCHAR(20),                       -- å»é‡èŒƒå›´ï¼ˆè®°å½•å½“æ—¶çš„è®¾ç½®ï¼‰
    
    -- å®¢æˆ·ç±»å‹ï¼ˆè®°å½•æ—¶çš„åˆ¤æ–­ï¼‰
    customer_type VARCHAR(50),                         -- 'new_realtime' | 'duplicate_realtime' ç­‰
    
    -- åŸå§‹æ•°æ®ï¼ˆJSONæ ¼å¼ä¿å­˜å®Œæ•´ä¸ŠæŠ¥æ•°æ®ï¼‰
    raw_data JSONB,
    
    -- ä¸»é”®ï¼ˆåŒ…å«incoming_timeç”¨äºåˆ†åŒºï¼‰
    PRIMARY KEY (id, incoming_time)
    
) PARTITION BY RANGE (incoming_time);

-- ç´¢å¼•
CREATE INDEX idx_incoming_logs_line_account ON incoming_logs(line_account_id, incoming_time DESC);
CREATE INDEX idx_incoming_logs_group_id ON incoming_logs(group_id, incoming_time DESC);
CREATE INDEX idx_incoming_logs_incoming_line_id ON incoming_logs(incoming_line_id);
CREATE INDEX idx_incoming_logs_duplicate ON incoming_logs(is_duplicate);
CREATE INDEX idx_incoming_logs_time ON incoming_logs(incoming_time DESC);

-- æ³¨é‡Š
COMMENT ON TABLE incoming_logs IS 'è¿›çº¿è®°å½•è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰';
COMMENT ON COLUMN incoming_logs.incoming_line_id IS 'è¿›çº¿å®¢æˆ·çš„Line User ID';
COMMENT ON COLUMN incoming_logs.is_duplicate IS 'æ˜¯å¦é‡å¤ï¼ˆæ ¹æ®åˆ†ç»„çš„å»é‡èŒƒå›´åˆ¤æ–­ï¼‰';
COMMENT ON COLUMN incoming_logs.customer_type IS 'å®¢æˆ·ç±»å‹ï¼šè®°å½•æ—¶çš„åˆ¤æ–­ç»“æœ';

-- åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆ2025å¹´ï¼‰
CREATE TABLE incoming_logs_2025_01 PARTITION OF incoming_logs
    FOR VALUES FROM ('2025-01-01 00:00:00') TO ('2025-02-01 00:00:00');

CREATE TABLE incoming_logs_2025_02 PARTITION OF incoming_logs
    FOR VALUES FROM ('2025-02-01 00:00:00') TO ('2025-03-01 00:00:00');

CREATE TABLE incoming_logs_2025_03 PARTITION OF incoming_logs
    FOR VALUES FROM ('2025-03-01 00:00:00') TO ('2025-04-01 00:00:00');

-- åç»­æœˆä»½çš„åˆ†åŒºå¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åˆ›å»º
-- æˆ–ä½¿ç”¨pg_partmanæ‰©å±•è‡ªåŠ¨ç®¡ç†

-- æ³¨æ„ï¼šæ¯ä¸ªåˆ†åŒºè¡¨ä¹Ÿéœ€è¦åˆ›å»ºç´¢å¼•
CREATE INDEX idx_incoming_logs_2025_01_line_account ON incoming_logs_2025_01(line_account_id, incoming_time DESC);
CREATE INDEX idx_incoming_logs_2025_01_group_id ON incoming_logs_2025_01(group_id, incoming_time DESC);
-- ... å…¶ä»–æœˆä»½ç±»ä¼¼
```

---

### 7. contact_poolï¼ˆåŸå§‹è”ç³»äººåº•åº“è¡¨ï¼‰

**è¯´æ˜**: å­˜å‚¨æ‰€æœ‰åŸå§‹è”ç³»äººï¼Œç”¨äºå»é‡åˆ¤æ–­

```sql
CREATE TABLE contact_pool (
    id BIGSERIAL PRIMARY KEY,
    
    -- æ¥æºä¿¡æ¯
    source_type VARCHAR(20) NOT NULL,                  -- 'import' | 'platform'
    import_batch_id INTEGER REFERENCES import_batches(id), -- å¯¼å…¥æ‰¹æ¬¡IDï¼ˆå¦‚æœæ˜¯å¯¼å…¥ï¼‰
    
    -- åˆ†ç»„ä¿¡æ¯
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    activation_code VARCHAR(32) NOT NULL,              -- å†—ä½™å­—æ®µ
    line_account_id INTEGER REFERENCES line_accounts(id), -- æ¥æºLineè´¦å·ï¼ˆå¦‚æœæ˜¯å¹³å°ä¸ŠæŠ¥ï¼‰
    
    -- å¹³å°ç±»å‹
    platform_type VARCHAR(20) NOT NULL,                -- 'line' | 'line_business'
    
    -- è”ç³»äººä¿¡æ¯
    line_id VARCHAR(100) NOT NULL,                     -- Line User ID
    display_name VARCHAR(100),                         -- æ˜¾ç¤ºåç§°
    phone_number VARCHAR(20),                          -- æ‰‹æœºå·
    avatar_url VARCHAR(500),                           -- å¤´åƒ
    
    -- å»é‡ä¿¡æ¯
    dedup_scope VARCHAR(20),                           -- å»é‡èŒƒå›´ï¼ˆè®°å½•æ·»åŠ æ—¶çš„è®¾ç½®ï¼‰
    first_seen_at TIMESTAMP,                           -- é¦–æ¬¡å‡ºç°æ—¶é—´
    
    -- å…¶ä»–ä¿¡æ¯
    remark TEXT,                                       -- å¤‡æ³¨
    metadata JSONB,                                    -- å…¶ä»–æ‰©å±•ä¿¡æ¯
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_source_type CHECK (source_type IN ('import', 'platform')),
    CONSTRAINT check_platform_type_cp CHECK (platform_type IN ('line', 'line_business'))
);

-- å”¯ä¸€ç´¢å¼•ï¼šå…¨å±€å»é‡ä½¿ç”¨
CREATE UNIQUE INDEX idx_contact_pool_global_unique ON contact_pool(line_id, platform_type);

-- å…¶ä»–ç´¢å¼•
CREATE INDEX idx_contact_pool_group_id ON contact_pool(group_id);
CREATE INDEX idx_contact_pool_activation_code ON contact_pool(activation_code);
CREATE INDEX idx_contact_pool_source_type ON contact_pool(source_type);
CREATE INDEX idx_contact_pool_line_id ON contact_pool(line_id);
CREATE INDEX idx_contact_pool_created ON contact_pool(created_at DESC);
CREATE INDEX idx_contact_pool_batch ON contact_pool(import_batch_id) WHERE import_batch_id IS NOT NULL;

-- æ³¨é‡Š
COMMENT ON TABLE contact_pool IS 'åŸå§‹è”ç³»äººåº•åº“è¡¨ï¼šç”¨äºå»é‡åˆ¤æ–­';
COMMENT ON COLUMN contact_pool.source_type IS 'æ¥æºï¼šimport=æ‰‹åŠ¨å¯¼å…¥, platform=å¹³å°ä¸ŠæŠ¥';
COMMENT ON COLUMN contact_pool.line_id IS 'Line User IDï¼Œå…¨å±€å”¯ä¸€ï¼ˆåŒä¸€å¹³å°ï¼‰';
```

---

### 8. customersï¼ˆå®¢æˆ·è¡¨ï¼‰

**è¯´æ˜**: å®¢æˆ·åˆ—è¡¨ï¼Œå…¨å±€å»é‡çš„è¿›çº¿æ—¥å¿—

```sql
CREATE TABLE customers (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    activation_code VARCHAR(32) NOT NULL,
    line_account_id INTEGER REFERENCES line_accounts(id), -- æ‰€å±Lineè´¦å·
    
    -- å¹³å°ç±»å‹
    platform_type VARCHAR(20) NOT NULL,                -- 'line' | 'line_business'
    
    -- å®¢æˆ·åŸºæœ¬ä¿¡æ¯
    customer_id VARCHAR(100) NOT NULL,                 -- Line User IDï¼ˆå…¨å±€å”¯ä¸€ï¼‰
    display_name VARCHAR(100),                         -- æ˜¾ç¤ºåç§°
    avatar_url VARCHAR(500),                           -- å¤´åƒURL
    phone_number VARCHAR(20),                          -- æ‰‹æœºå·
    
    -- å®¢æˆ·åˆ†ç±»
    customer_type VARCHAR(50),                         -- å®¢æˆ·ç±»å‹
    gender VARCHAR(10),                                -- 'male' | 'female' | 'unknown'
    country VARCHAR(50),                               -- å›½å®¶
    birthday DATE,                                     -- ç”Ÿæ—¥
    address TEXT,                                      -- åœ°å€
    
    -- å¤‡æ³¨
    nickname_remark VARCHAR(20),                       -- æ˜µç§°å¤‡æ³¨ï¼ˆé™20å­—ï¼‰
    remark TEXT,                                       -- è¯¦ç»†å¤‡æ³¨
    tags JSONB,                                        -- æ ‡ç­¾ï¼ˆJSONæ•°ç»„ï¼‰
    
    -- å®¢æˆ·ç”»åƒï¼ˆæ‰©å±•ä¿¡æ¯ï¼‰
    profile_data JSONB,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,    -- é¦–æ¬¡æ·»åŠ æ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,    -- æœ€åæ›´æ–°æ—¶é—´
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_platform_type_cust CHECK (platform_type IN ('line', 'line_business')),
    CONSTRAINT check_gender CHECK (gender IN ('male', 'female', 'unknown')),
    CONSTRAINT check_customer_type CHECK (customer_type IN (
        'æ–°å¢çº¿ç´¢-å®æ—¶', 'æ–°å¢çº¿ç´¢-è¡¥å½•', 'æ–°å¢çº¿ç´¢-é‡å¤', 'æ–°å¢çº¿ç´¢-å¯¼å…¥é‡å¤'
    ))
);

-- å”¯ä¸€ç´¢å¼•ï¼šå…¨å±€å”¯ä¸€ï¼ˆåŒä¸€å¹³å°ï¼‰
CREATE UNIQUE INDEX idx_customers_unique ON customers(customer_id, platform_type) WHERE deleted_at IS NULL;

-- å…¶ä»–ç´¢å¼•
CREATE INDEX idx_customers_group_id ON customers(group_id);
CREATE INDEX idx_customers_activation_code ON customers(activation_code);
CREATE INDEX idx_customers_line_account ON customers(line_account_id);
CREATE INDEX idx_customers_platform_type ON customers(platform_type);
CREATE INDEX idx_customers_customer_type ON customers(customer_type);
CREATE INDEX idx_customers_country ON customers(country);
CREATE INDEX idx_customers_created ON customers(created_at DESC);
CREATE INDEX idx_customers_updated ON customers(updated_at DESC);
CREATE INDEX idx_customers_deleted ON customers(deleted_at);

-- æ³¨é‡Š
COMMENT ON TABLE customers IS 'å®¢æˆ·è¡¨ï¼šå…¨å±€å»é‡çš„è¿›çº¿æ—¥å¿—';
COMMENT ON COLUMN customers.customer_id IS 'Line User IDï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†';
COMMENT ON COLUMN customers.customer_type IS 'å®¢æˆ·ç±»å‹ï¼šæ–°å¢çº¿ç´¢-å®æ—¶/è¡¥å½•/é‡å¤/å¯¼å…¥é‡å¤';
```

---

### 9. follow_up_recordsï¼ˆè·Ÿè¿›è®°å½•è¡¨ï¼‰

**è¯´æ˜**: å®¢æˆ·è·Ÿè¿›è®°å½•

```sql
CREATE TABLE follow_up_records (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    activation_code VARCHAR(32) NOT NULL,
    line_account_id INTEGER REFERENCES line_accounts(id), -- Lineä¸»è´¦å·
    customer_id BIGINT REFERENCES customers(id),       -- å®¢æˆ·
    
    -- å¹³å°ç±»å‹
    platform_type VARCHAR(20) NOT NULL,
    
    -- å†—ä½™å­—æ®µï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
    line_account_display_name VARCHAR(100),            -- ä¸»è´¦å·æ˜¾ç¤ºåç§°
    line_account_line_id VARCHAR(100),                 -- ä¸»è´¦å·Line ID
    line_account_avatar_url VARCHAR(500),              -- ä¸»è´¦å·å¤´åƒ
    
    customer_display_name VARCHAR(100),                -- å®¢æˆ·æ˜¾ç¤ºåç§°
    customer_line_id VARCHAR(100),                     -- å®¢æˆ·Line User ID
    customer_avatar_url VARCHAR(500),                  -- å®¢æˆ·å¤´åƒ
    
    -- è·Ÿè¿›å†…å®¹
    content TEXT NOT NULL,                             -- è·Ÿè¿›è®°å½•å†…å®¹
    
    -- åˆ›å»ºè€…
    created_by INTEGER REFERENCES users(id),           -- åˆ›å»ºäºº
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_platform_type_fup CHECK (platform_type IN ('line', 'line_business'))
);

-- ç´¢å¼•
CREATE INDEX idx_follow_up_group_id ON follow_up_records(group_id, created_at DESC);
CREATE INDEX idx_follow_up_activation_code ON follow_up_records(activation_code);
CREATE INDEX idx_follow_up_line_account ON follow_up_records(line_account_id);
CREATE INDEX idx_follow_up_customer ON follow_up_records(customer_id);
CREATE INDEX idx_follow_up_platform ON follow_up_records(platform_type);
CREATE INDEX idx_follow_up_created ON follow_up_records(created_at DESC);
CREATE INDEX idx_follow_up_deleted ON follow_up_records(deleted_at);

-- æ³¨é‡Š
COMMENT ON TABLE follow_up_records IS 'è·Ÿè¿›è®°å½•è¡¨';
COMMENT ON COLUMN follow_up_records.content IS 'è·Ÿè¿›è®°å½•è¯¦ç»†å†…å®¹';
```

---

### 10. account_status_logsï¼ˆè´¦å·çŠ¶æ€æ—¥å¿—è¡¨ï¼‰

**è¯´æ˜**: è®°å½•Lineè´¦å·çš„ä¸Šä¸‹çº¿å†å²ï¼ŒæŒ‰æœˆåˆ†åŒº

```sql
CREATE TABLE account_status_logs (
    id BIGSERIAL,
    line_account_id INTEGER NOT NULL,
    
    -- çŠ¶æ€å˜åŒ–
    from_status VARCHAR(20) NOT NULL,                  -- åŸçŠ¶æ€
    to_status VARCHAR(20) NOT NULL,                    -- æ–°çŠ¶æ€
    
    -- å˜åŒ–åŸå› 
    reason VARCHAR(50) NOT NULL,                       -- åŸå› 
    
    -- å…¶ä»–ä¿¡æ¯
    ip_address VARCHAR(50),                            -- IPåœ°å€
    occurred_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®ï¼ˆåŒ…å«occurred_atç”¨äºåˆ†åŒºï¼‰
    PRIMARY KEY (id, occurred_at),
    
    -- çº¦æŸ
    CONSTRAINT check_from_status CHECK (from_status IN ('online', 'offline', 'user_logout', 'abnormal_offline')),
    CONSTRAINT check_to_status CHECK (to_status IN ('online', 'offline', 'user_logout', 'abnormal_offline')),
    CONSTRAINT check_reason CHECK (reason IN ('user_login', 'user_logout', 'abnormal_offline', 'force_offline'))
    
) PARTITION BY RANGE (occurred_at);

-- ç´¢å¼•
CREATE INDEX idx_account_status_logs_account ON account_status_logs(line_account_id, occurred_at DESC);
CREATE INDEX idx_account_status_logs_time ON account_status_logs(occurred_at DESC);

-- æ³¨é‡Š
COMMENT ON TABLE account_status_logs IS 'è´¦å·çŠ¶æ€æ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰';
COMMENT ON COLUMN account_status_logs.reason IS 'å˜åŒ–åŸå› ï¼šuser_login/user_logout/abnormal_offline/force_offline';

-- åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆ2025å¹´ï¼‰
CREATE TABLE account_status_logs_2025_01 PARTITION OF account_status_logs
    FOR VALUES FROM ('2025-01-01 00:00:00') TO ('2025-02-01 00:00:00');

CREATE TABLE account_status_logs_2025_02 PARTITION OF account_status_logs
    FOR VALUES FROM ('2025-02-01 00:00:00') TO ('2025-03-01 00:00:00');

CREATE TABLE account_status_logs_2025_03 PARTITION OF account_status_logs
    FOR VALUES FROM ('2025-03-01 00:00:00') TO ('2025-04-01 00:00:00');
```

---

### 11. import_batchesï¼ˆå¯¼å…¥æ‰¹æ¬¡è¡¨ï¼‰

**è¯´æ˜**: è®°å½•æ‰‹åŠ¨å¯¼å…¥çš„æ‰¹æ¬¡ä¿¡æ¯

```sql
CREATE TABLE import_batches (
    id SERIAL PRIMARY KEY,
    
    -- æ‰¹æ¬¡ä¿¡æ¯
    batch_name VARCHAR(100),                           -- æ‰¹æ¬¡åç§°
    platform_type VARCHAR(20) NOT NULL,                -- å¹³å°ç±»å‹
    
    -- å¯¼å…¥ç»Ÿè®¡
    total_count INTEGER DEFAULT 0,                     -- æ€»å¯¼å…¥æ•°é‡
    success_count INTEGER DEFAULT 0,                   -- æˆåŠŸæ•°é‡
    duplicate_count INTEGER DEFAULT 0,                 -- é‡å¤æ•°é‡
    error_count INTEGER DEFAULT 0,                     -- é”™è¯¯æ•°é‡
    
    -- å»é‡è®¾ç½®
    dedup_scope VARCHAR(20),                           -- å»é‡èŒƒå›´
    
    -- æ–‡ä»¶ä¿¡æ¯
    file_name VARCHAR(255),                            -- åŸå§‹æ–‡ä»¶å
    file_path VARCHAR(500),                            -- æ–‡ä»¶å­˜å‚¨è·¯å¾„
    file_size INTEGER,                                 -- æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    
    -- å¯¼å…¥è€…
    imported_by INTEGER REFERENCES users(id),          -- å¯¼å…¥ç”¨æˆ·
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,                            -- å®Œæˆæ—¶é—´
    
    -- çº¦æŸ
    CONSTRAINT check_platform_type_batch CHECK (platform_type IN ('line', 'line_business')),
    CONSTRAINT check_dedup_scope_batch CHECK (dedup_scope IN ('current', 'global'))
);

-- ç´¢å¼•
CREATE INDEX idx_import_batches_platform ON import_batches(platform_type);
CREATE INDEX idx_import_batches_created ON import_batches(created_at DESC);
CREATE INDEX idx_import_batches_user ON import_batches(imported_by);

-- æ³¨é‡Š
COMMENT ON TABLE import_batches IS 'å¯¼å…¥æ‰¹æ¬¡è¡¨';
```

---

## ğŸ”§ è§¦å‘å™¨è®¾è®¡

### è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

```sql
-- åˆ›å»ºé€šç”¨è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨åˆ°å„ä¸ªè¡¨
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_groups_updated_at
    BEFORE UPDATE ON groups
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_line_accounts_updated_at
    BEFORE UPDATE ON line_accounts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_customers_updated_at
    BEFORE UPDATE ON customers
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ... å…¶ä»–è¡¨ç±»ä¼¼
```

---

## ğŸ” è§†å›¾è®¾è®¡ï¼ˆå¯é€‰ï¼‰

### çº¿ç´¢åˆ—è¡¨è§†å›¾ï¼ˆç®€åŒ–æŸ¥è¯¢ï¼‰

```sql
CREATE VIEW v_leads_list AS
SELECT 
    g.id as group_id,
    g.activation_code,
    g.user_id,
    g.is_active,
    g.remark,
    g.description,
    g.category,
    g.dedup_scope,
    g.reset_time,
    g.created_at,
    g.last_login_at,
    g.account_limit,
    
    -- ç»Ÿè®¡æ•°æ®ï¼ˆä»statsè¡¨è¯»å–ï¼‰
    COALESCE(gs.total_accounts, 0) as total_accounts,
    COALESCE(gs.online_accounts, 0) as online_accounts,
    COALESCE(gs.line_accounts, 0) as line_accounts,
    COALESCE(gs.line_business_accounts, 0) as line_business_accounts,
    COALESCE(gs.today_incoming, 0) as today_incoming,
    COALESCE(gs.total_incoming, 0) as total_incoming,
    COALESCE(gs.duplicate_incoming, 0) as duplicate_incoming,
    COALESCE(gs.today_duplicate, 0) as today_duplicate

FROM groups g
LEFT JOIN group_stats gs ON gs.group_id = g.id

WHERE g.deleted_at IS NULL;

-- æ³¨é‡Š
COMMENT ON VIEW v_leads_list IS 'çº¿ç´¢åˆ—è¡¨è§†å›¾ï¼šç®€åŒ–å‰ç«¯æŸ¥è¯¢';
```

---

## ğŸ“Š åˆ†åŒºç®¡ç†

### è‡ªåŠ¨åˆ›å»ºæœªæ¥åˆ†åŒºçš„å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION create_next_month_partitions()
RETURNS void AS $$
DECLARE
    next_month_start DATE;
    next_month_end DATE;
    partition_name TEXT;
BEGIN
    -- è®¡ç®—ä¸‹ä¸ªæœˆçš„èµ·å§‹æ—¥æœŸ
    next_month_start := DATE_TRUNC('month', CURRENT_DATE + INTERVAL '1 month');
    next_month_end := next_month_start + INTERVAL '1 month';
    
    -- åˆ›å»ºincoming_logsåˆ†åŒº
    partition_name := 'incoming_logs_' || TO_CHAR(next_month_start, 'YYYY_MM');
    
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF incoming_logs
         FOR VALUES FROM (%L) TO (%L)',
        partition_name,
        next_month_start,
        next_month_end
    );
    
    -- åˆ›å»ºç´¢å¼•
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_%I_line_account ON %I(line_account_id, incoming_time DESC)', partition_name, partition_name);
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_%I_group_id ON %I(group_id, incoming_time DESC)', partition_name, partition_name);
    
    -- åˆ›å»ºaccount_status_logsåˆ†åŒºï¼ˆç±»ä¼¼ï¼‰
    partition_name := 'account_status_logs_' || TO_CHAR(next_month_start, 'YYYY_MM');
    
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF account_status_logs
         FOR VALUES FROM (%L) TO (%L)',
        partition_name,
        next_month_start,
        next_month_end
    );
    
    RAISE NOTICE 'Created partitions for %', TO_CHAR(next_month_start, 'YYYY-MM');
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡ï¼šæ¯æœˆ1å·è‡ªåŠ¨åˆ›å»ºä¸‹ä¸ªæœˆçš„åˆ†åŒº
-- åœ¨åº”ç”¨å±‚ä½¿ç”¨å®šæ—¶ä»»åŠ¡è°ƒç”¨æ­¤å‡½æ•°
```

---

## ğŸ” å®‰å…¨è®¾è®¡

### Row Level Securityï¼ˆè¡Œçº§å®‰å…¨ï¼‰å¯é€‰

```sql
-- å¯ç”¨RLS
ALTER TABLE line_accounts ENABLE ROW LEVEL SECURITY;

-- ç®¡ç†å‘˜ç­–ç•¥ï¼šæŸ¥çœ‹æ‰€æœ‰æ•°æ®
CREATE POLICY admin_all ON line_accounts
    FOR ALL
    TO admin_role
    USING (true);

-- æ™®é€šç”¨æˆ·ç­–ç•¥ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„åˆ†ç»„çš„æ•°æ®
CREATE POLICY user_own_groups ON line_accounts
    FOR ALL
    TO user_role
    USING (
        group_id IN (
            SELECT id FROM groups WHERE user_id = current_user_id()
        )
    );

-- å­è´¦å·ç­–ç•¥ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±åˆ†ç»„çš„æ•°æ®
CREATE POLICY subaccount_own_group ON line_accounts
    FOR ALL
    TO subaccount_role
    USING (group_id = current_group_id());
```

**è¯´æ˜**: RLSå¯é€‰ï¼Œä¹Ÿå¯ä»¥åœ¨åº”ç”¨å±‚å®ç°æƒé™è¿‡æ»¤

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åˆ†åŒºç­–ç•¥
- âœ… incoming_logs æŒ‰æœˆåˆ†åŒºï¼ˆå†å²æ•°æ®æŸ¥è¯¢å¿«ï¼‰
- âœ… account_status_logs æŒ‰æœˆåˆ†åŒº
- âœ… è‡ªåŠ¨ç®¡ç†åˆ†åŒºï¼ˆæ¯æœˆåˆ›å»ºä¸‹æœˆåˆ†åŒºï¼‰
- âœ… å®šæœŸå½’æ¡£æ—§åˆ†åŒºï¼ˆå¦‚ä¿ç•™12ä¸ªæœˆæ•°æ®ï¼‰

### 2. ç´¢å¼•ä¼˜åŒ–
- âœ… å¤åˆç´¢å¼•è¦†ç›–å¸¸ç”¨æŸ¥è¯¢
- âœ… åˆ†åŒºè¡¨ä¹Ÿéœ€è¦åˆ›å»ºç´¢å¼•
- âœ… ä½¿ç”¨BRINç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰

### 3. æŸ¥è¯¢ä¼˜åŒ–
- âœ… ä½¿ç”¨ç»Ÿè®¡è¡¨é¿å…å®æ—¶è®¡ç®—
- âœ… å†—ä½™å­—æ®µå‡å°‘JOIN
- âœ… ä½¿ç”¨è§†å›¾ç®€åŒ–å¤æ‚æŸ¥è¯¢

### 4. æ•°æ®å½’æ¡£
- âœ… å®šæœŸå½’æ¡£æ—§çš„è¿›çº¿æ—¥å¿—
- âœ… ä¿ç•™æœ€è¿‘12ä¸ªæœˆçš„åˆ†åŒº
- âœ… æ—§æ•°æ®ç§»åˆ°å½’æ¡£è¡¨æˆ–å¯¼å‡º

---

## âœ… æ•°æ®åº“åˆå§‹åŒ–æ¸…å•

### åˆ›å»ºé¡ºåº

```sql
-- 1. åˆ›å»ºæšä¸¾ç±»å‹
-- ï¼ˆGoä¸­ä¸€èˆ¬ä½¿ç”¨å­—ç¬¦ä¸²+CHECKçº¦æŸï¼‰

-- 2. åˆ›å»ºåŸºç¡€è¡¨
CREATE TABLE users (...);
CREATE TABLE groups (...);

-- 3. åˆ›å»ºç»Ÿè®¡è¡¨
CREATE TABLE group_stats (...);

-- 4. åˆ›å»ºä¸šåŠ¡è¡¨
CREATE TABLE line_accounts (...);
CREATE TABLE line_account_stats (...);

-- 5. åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆå…ˆåˆ›å»ºçˆ¶è¡¨ï¼Œå†åˆ›å»ºåˆ†åŒºï¼‰
CREATE TABLE incoming_logs (...) PARTITION BY RANGE (incoming_time);
CREATE TABLE incoming_logs_2025_01 PARTITION OF incoming_logs ...;
-- ... å…¶ä»–åˆ†åŒº

CREATE TABLE account_status_logs (...) PARTITION BY RANGE (occurred_at);
CREATE TABLE account_status_logs_2025_01 PARTITION OF account_status_logs ...;
-- ... å…¶ä»–åˆ†åŒº

-- 6. åˆ›å»ºå…¶ä»–è¡¨
CREATE TABLE contact_pool (...);
CREATE TABLE customers (...);
CREATE TABLE follow_up_records (...);
CREATE TABLE import_batches (...);

-- 7. åˆ›å»ºå¤§æ¨¡å‹ç›¸å…³è¡¨
CREATE TABLE llm_configs (...);
CREATE TABLE llm_prompt_templates (...);
CREATE TABLE llm_call_logs (...);

-- 8. åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER ...;

-- 9. åˆ›å»ºè§†å›¾
CREATE VIEW v_leads_list ...;

-- 10. åˆ›å»ºç´¢å¼•ï¼ˆå¦‚æœæ²¡åœ¨è¡¨å®šä¹‰ä¸­åˆ›å»ºï¼‰

-- 11. æ’å…¥åˆå§‹æ•°æ®ï¼ˆç®¡ç†å‘˜è´¦å·ï¼‰
INSERT INTO users (username, password_hash, role) 
VALUES ('admin', '$2a$10$...', 'admin');
```

---

## ğŸ¯ ä¸Goåç«¯çš„é…åˆ

### GORMæ¨¡å‹ç¤ºä¾‹

```go
// Group åˆ†ç»„æ¨¡å‹
type Group struct {
    ID              uint      `gorm:"primaryKey"`
    UserID          uint      `gorm:"not null;index"`
    ActivationCode  string    `gorm:"size:32;uniqueIndex;not null"`
    AccountLimit    *int      `gorm:"default:null"`
    IsActive        bool      `gorm:"default:true;index"`
    Remark          string    `gorm:"size:255"`
    Description     string    `gorm:"type:text"`
    Category        string    `gorm:"size:50;default:'é»˜è®¤åˆ†ç»„'"`
    DedupScope      string    `gorm:"size:20;default:'current'"`
    ResetTime       time.Time `gorm:"type:time;default:'09:00:00'"`
    LoginPassword   *string   `gorm:"size:255"`
    CreatedAt       time.Time
    UpdatedAt       time.Time
    LastLoginAt     *time.Time
    DeletedAt       gorm.DeletedAt `gorm:"index"`
    
    // å…³è”
    User            User      `gorm:"foreignKey:UserID"`
    Stats           GroupStats `gorm:"foreignKey:GroupID"`
    LineAccounts    []LineAccount `gorm:"foreignKey:GroupID"`
}

// GroupStats åˆ†ç»„ç»Ÿè®¡æ¨¡å‹
type GroupStats struct {
    ID                     uint `gorm:"primaryKey"`
    GroupID                uint `gorm:"uniqueIndex;not null"`
    TotalAccounts          int  `gorm:"default:0"`
    OnlineAccounts         int  `gorm:"default:0"`
    LineAccounts           int  `gorm:"default:0"`
    LineBusinessAccounts   int  `gorm:"default:0"`
    TodayIncoming          int  `gorm:"default:0"`
    TotalIncoming          int  `gorm:"default:0"`
    DuplicateIncoming      int  `gorm:"default:0"`
    TodayDuplicate         int  `gorm:"default:0"`
    LastResetDate          *time.Time
    LastResetTime          *time.Time
    UpdatedAt              time.Time
}
```

---

---

### 12. llm_configsï¼ˆå¤§æ¨¡å‹é…ç½®è¡¨ï¼‰

**è¯´æ˜**: å­˜å‚¨å¤§æ¨¡å‹APIé…ç½®ï¼Œä»…ç®¡ç†å‘˜å¯ç®¡ç†

```sql
CREATE TABLE llm_configs (
    id SERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,                        -- é…ç½®åç§°
    provider VARCHAR(50) NOT NULL,                     -- æä¾›å•†
    
    -- APIé…ç½®
    api_url VARCHAR(500) NOT NULL,                     -- APIåœ°å€
    api_key TEXT NOT NULL,                             -- API Keyï¼ˆAESåŠ å¯†å­˜å‚¨ï¼‰
    model VARCHAR(100) NOT NULL,                       -- æ¨¡å‹åç§°
    
    -- å‚æ•°é…ç½®
    max_tokens INTEGER DEFAULT 2000,
    temperature DECIMAL(3,2) DEFAULT 0.7,
    top_p DECIMAL(3,2) DEFAULT 1.0,
    frequency_penalty DECIMAL(3,2) DEFAULT 0.0,
    presence_penalty DECIMAL(3,2) DEFAULT 0.0,
    
    -- System Prompt
    system_prompt TEXT,
    
    -- é«˜çº§é…ç½®
    timeout_seconds INTEGER DEFAULT 30,
    max_retries INTEGER DEFAULT 3,
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id),
    
    -- çº¦æŸ
    CONSTRAINT check_provider CHECK (provider IN (
        'openai', 'anthropic', 'aliyun', 'xunfei', 'baidu', 'zhipu', 'custom'
    ))
);

-- ç´¢å¼•
CREATE INDEX idx_llm_configs_provider ON llm_configs(provider);
CREATE INDEX idx_llm_configs_is_active ON llm_configs(is_active);

-- æ³¨é‡Š
COMMENT ON TABLE llm_configs IS 'å¤§æ¨¡å‹é…ç½®è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯ç®¡ç†ï¼‰';
COMMENT ON COLUMN llm_configs.api_key IS 'API Keyï¼ˆAES-256åŠ å¯†å­˜å‚¨ï¼‰';
```

---

### 13. llm_prompt_templatesï¼ˆPromptæ¨¡æ¿è¡¨ï¼‰

**è¯´æ˜**: å­˜å‚¨Promptæ¨¡æ¿ï¼Œæ”¯æŒå˜é‡æ›¿æ¢

```sql
CREATE TABLE llm_prompt_templates (
    id SERIAL PRIMARY KEY,
    
    -- å…³è”é…ç½®
    config_id INTEGER NOT NULL REFERENCES llm_configs(id) ON DELETE CASCADE,
    
    -- æ¨¡æ¿ä¿¡æ¯
    template_name VARCHAR(100) NOT NULL,               -- æ¨¡æ¿åç§°
    template_content TEXT NOT NULL,                    -- æ¨¡æ¿å†…å®¹
    
    -- å˜é‡å®šä¹‰
    variables JSONB,                                   -- å˜é‡åˆ—è¡¨ ["customer_name", "message"]
    
    -- æè¿°
    description TEXT,
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_prompt_templates_config ON llm_prompt_templates(config_id);
CREATE INDEX idx_prompt_templates_active ON llm_prompt_templates(is_active);

-- æ³¨é‡Š
COMMENT ON TABLE llm_prompt_templates IS 'Promptæ¨¡æ¿è¡¨';
COMMENT ON COLUMN llm_prompt_templates.variables IS 'æ¨¡æ¿å˜é‡åˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰';
```

---

### 14. llm_call_logsï¼ˆå¤§æ¨¡å‹è°ƒç”¨è®°å½•è¡¨ï¼‰

**è¯´æ˜**: è®°å½•æ‰€æœ‰å¤§æ¨¡å‹APIè°ƒç”¨å†å²

```sql
CREATE TABLE llm_call_logs (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    config_id INTEGER REFERENCES llm_configs(id),
    template_id INTEGER REFERENCES llm_prompt_templates(id),
    
    -- è°ƒç”¨è€…ä¿¡æ¯
    group_id INTEGER REFERENCES groups(id),            -- å“ªä¸ªåˆ†ç»„è°ƒç”¨çš„
    activation_code VARCHAR(32),                       -- æ¿€æ´»ç 
    
    -- è¯·æ±‚ä¿¡æ¯
    request_messages JSONB NOT NULL,                   -- è¯·æ±‚æ¶ˆæ¯ï¼ˆå®Œæ•´JSONï¼‰
    request_params JSONB,                              -- è¯·æ±‚å‚æ•°
    
    -- å“åº”ä¿¡æ¯
    response_content TEXT,                             -- å“åº”å†…å®¹
    response_data JSONB,                               -- å®Œæ•´å“åº”ï¼ˆJSONï¼‰
    
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(20) NOT NULL,                       -- 'success' | 'error'
    error_message TEXT,                                -- é”™è¯¯ä¿¡æ¯
    
    -- Tokenç»Ÿè®¡
    tokens_used INTEGER,                               -- Tokenæ€»ä½¿ç”¨é‡
    prompt_tokens INTEGER,                             -- Prompt Token
    completion_tokens INTEGER,                         -- Completion Token
    
    -- æ—¶é—´ä¿¡æ¯
    call_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,     -- è°ƒç”¨æ—¶é—´
    duration_ms INTEGER,                               -- è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    
    -- çº¦æŸ
    CONSTRAINT check_llm_status CHECK (status IN ('success', 'error'))
);

-- ç´¢å¼•
CREATE INDEX idx_llm_call_logs_config ON llm_call_logs(config_id, call_time DESC);
CREATE INDEX idx_llm_call_logs_group ON llm_call_logs(group_id, call_time DESC);
CREATE INDEX idx_llm_call_logs_activation ON llm_call_logs(activation_code);
CREATE INDEX idx_llm_call_logs_time ON llm_call_logs(call_time DESC);
CREATE INDEX idx_llm_call_logs_status ON llm_call_logs(status);

-- æ³¨é‡Š
COMMENT ON TABLE llm_call_logs IS 'å¤§æ¨¡å‹è°ƒç”¨è®°å½•è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ï¼‰';
COMMENT ON COLUMN llm_call_logs.tokens_used IS 'Tokenæ€»ä½¿ç”¨é‡';
```

---

## âœ… å·²ç¡®è®¤å†…å®¹

- [x] æŠ€æœ¯é€‰å‹ï¼šGo + Vue3 + Element Plus
- [x] æ•°æ®åº“ï¼šPostgreSQL
- [x] 14å¼ æ ¸å¿ƒè¡¨è®¾è®¡å®Œæˆï¼ˆæ–°å¢3å¼ å¤§æ¨¡å‹è¡¨ï¼‰
- [x] åˆ†åŒºè¡¨è®¾è®¡ï¼ˆincoming_logsã€account_status_logsï¼‰
- [x] ç»Ÿè®¡è¡¨è®¾è®¡ï¼ˆå¢é‡æ›´æ–°ï¼‰
- [x] å¤§æ¨¡å‹è¡¨è®¾è®¡ï¼ˆé…ç½®ã€æ¨¡æ¿ã€è°ƒç”¨è®°å½•ï¼‰
- [x] ç´¢å¼•ä¼˜åŒ–
- [x] è§¦å‘å™¨è®¾è®¡
- [x] è§†å›¾è®¾è®¡
- [x] çº¦æŸå’Œæ ¡éªŒ
- [x] è½¯åˆ é™¤æ”¯æŒ
- [x] åˆ†åŒºè‡ªåŠ¨ç®¡ç†
- [x] API KeyåŠ å¯†å­˜å‚¨


