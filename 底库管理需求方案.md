# 底库管理（原始联系人管理）- 需求方案

> **版本**: v1.0
> **更新日期**: 2025-12-21
> **说明**: 基于CEO SCRM系统底库管理页面设计，全部功能保留（移除导出功能）

---

## 📋 页面概述

### 核心功能
底库管理用于管理原始联系人（底库），当激活码的粉丝去重范围为"账号下激活码"时，会和底库管理中的全部线索进行去重统计。

### 页面路径
`/base-contacts` 或 `/contact-pool`

### 页面说明
当激活码的粉丝去重范围为"账号下激活码"时，会和底库管理中的全部线索进行去重统计

---

## 📊 统计卡片

### 三个统计指标

#### 1. 导入原始联系人数量
- **说明**: 手动导入的原始联系人总数
- **显示**: 大数字 + 帮助图标
- **示例**: `0`

#### 2. 平台工单原始联系人数量
- **说明**: 通过平台工单收集的原始联系人总数
- **显示**: 大数字
- **示例**: `7215`

#### 3. 原始联系人数量汇总
- **说明**: 所有原始联系人的总计数量（导入 + 平台工单）
- **显示**: 大数字
- **计算公式**: `导入数量 + 平台工单数量`
- **示例**: `7215`

---

## 📑 标签页结构

### 标签页1：导入原始联系人数量

#### 功能按钮

**导入原始联系人按钮**:
- **按钮文字**: `➕ 导入原始联系人`
- **功能**: 上传文件导入原始联系人数据
- **支持格式**: 
  - Excel (.xlsx, .xls)
  - CSV (.csv)
  - TXT (.txt)
- **导入字段**:
  - Line ID（必填）
  - 显示名称（可选）
  - 手机号（可选）
  - 平台类型（Line / Line Business）
  - 备注（可选）

#### 数据列表

**表格字段**:

| 序号 | 字段名 | 说明 |
|-----|--------|------|
| 1 | ☑ | 复选框 |
| 2 | 平台 | Line / Line Business |
| 3 | 原始联系人数量 | 该平台的联系人总数 |
| 4 | 去重范围 | 去重设置 |
| 5 | 操作 | 操作按钮 |

**字段说明**:

##### 1. 平台
- **字段名**: `platform_type`
- **类型**: `VARCHAR(20)`
- **可选值**: `line` / `line_business`
- **显示方式**: 文字或图标

**示例**:
```
Line
Line Business
```

##### 2. 原始联系人数量
- **字段名**: `contact_count`
- **类型**: `INTEGER`
- **说明**: 该平台下导入的原始联系人总数

**示例**:
```
1500
800
```

##### 3. 去重范围
- **字段名**: `dedup_scope`
- **类型**: `VARCHAR(20)`
- **说明**: 该批次联系人的去重范围设置
- **可选值**:
  - `当前激活码`
  - `全局`
  - `自定义分组`

##### 4. 操作
- **操作按钮**: 
  - **查看**: 查看该批次的详细联系人列表
  - **编辑**: 编辑去重范围等设置
  - **删除**: 删除该批次的导入记录

---

### 标签页2：平台工单原始联系人数量

#### 筛选功能

**筛选条件**:

##### 1. 平台选择
- **字段**: `platform_type`
- **类型**: 下拉选择
- **选项**:
  - 全部平台
  - Line
  - Line Business

**显示**:
```
[请选择平台 ▼]
```

##### 2. 激活码搜索
- **字段**: `activation_code`
- **类型**: 文本输入框
- **占位符**: "请输入激活码"
- **匹配方式**: 模糊搜索

**筛选操作按钮**:
```
[🔍 搜索]  [🔄 重选]
```

#### 数据列表

**表格字段**:

| 序号 | 字段名 | 说明 |
|-----|--------|------|
| 1 | 激活码 | 分组的激活码 |
| 2 | 备注 | 分组备注信息 |
| 3 | 平台 | Line / Line Business |
| 4 | 原始联系人数量 | 该激活码下该平台的联系人数 |
| 5 | 操作 | 查看 |

**字段说明**:

##### 1. 激活码
- **字段名**: `activation_code`
- **类型**: `VARCHAR(32)`
- **说明**: 分组的激活码
- **显示方式**: 文字显示

**示例**:
```
2nXZMRbA
zsXnJbgU
tqfCRQZx
```

##### 2. 备注
- **字段名**: `remark`
- **类型**: `VARCHAR(255)`
- **说明**: 该激活码（分组）的备注信息
- **显示方式**: 文字显示（可能为空）

**示例**:
```
小n
大鱼
（空）
```

##### 3. 平台
- **字段名**: `platform_type`
- **类型**: `VARCHAR(20)`
- **说明**: Line平台类型
- **可选值**: 
  - `Line`
  - `Line Business`

**显示方式**:
```
Line
Line Business
```

##### 4. 原始联系人数量
- **字段名**: `contact_count`
- **类型**: `INTEGER`
- **说明**: 该激活码下该平台的原始联系人总数

**显示方式**: 数字
```
31
115
200
360
661
```

**计算逻辑**:
- 统计该激活码下该平台所有收集到的进线联系人数量
- 包括已去重和重复的联系人

##### 5. 操作
- **操作按钮**:
  - **查看**: 查看该激活码下该平台的详细联系人列表

**按钮显示**:
```
[👁️ 查看]
```

---

## 💾 数据库表结构

### contact_pool 表（原始联系人底库表）

```sql
CREATE TABLE contact_pool (
    id BIGSERIAL PRIMARY KEY,
    
    -- 来源信息
    source_type VARCHAR(20) NOT NULL,                  -- 'import' | 'platform'
    import_batch_id INTEGER,                           -- 导入批次ID（如果是导入的）
    activation_code VARCHAR(32),                       -- 激活码（如果是平台来源）
    group_id INTEGER REFERENCES groups(id),            -- 分组ID
    
    -- 平台信息
    platform_type VARCHAR(20) NOT NULL,                -- 'line' | 'line_business'
    
    -- 联系人信息
    line_id VARCHAR(100) NOT NULL,                     -- Line ID
    display_name VARCHAR(100),                         -- 显示名称
    phone_number VARCHAR(20),                          -- 手机号
    
    -- 去重信息
    dedup_scope VARCHAR(20),                           -- 去重范围
    is_duplicate BOOLEAN DEFAULT FALSE,                -- 是否是重复联系人
    first_seen_at TIMESTAMP,                           -- 首次出现时间
    
    -- 其他信息
    remark TEXT,                                       -- 备注
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_source_type (source_type),
    INDEX idx_activation_code (activation_code),
    INDEX idx_platform_type (platform_type),
    INDEX idx_line_id (line_id),
    INDEX idx_created_at (created_at),
    INDEX idx_batch (import_batch_id)
);

-- 唯一性约束（Line ID在同一去重范围内唯一）
CREATE UNIQUE INDEX idx_unique_line_id_scope 
ON contact_pool(line_id, dedup_scope) 
WHERE dedup_scope IS NOT NULL;
```

### import_batches 表（导入批次表）

```sql
CREATE TABLE import_batches (
    id SERIAL PRIMARY KEY,
    
    -- 批次信息
    batch_name VARCHAR(100),                           -- 批次名称
    platform_type VARCHAR(20) NOT NULL,                -- 平台类型
    
    -- 导入统计
    total_count INTEGER DEFAULT 0,                     -- 总导入数量
    success_count INTEGER DEFAULT 0,                   -- 成功数量
    duplicate_count INTEGER DEFAULT 0,                 -- 重复数量
    error_count INTEGER DEFAULT 0,                     -- 错误数量
    
    -- 去重设置
    dedup_scope VARCHAR(20),                           -- 去重范围
    
    -- 文件信息
    file_name VARCHAR(255),                            -- 原始文件名
    file_path VARCHAR(500),                            -- 文件存储路径
    file_size INTEGER,                                 -- 文件大小（字节）
    
    -- 导入者
    imported_by INTEGER REFERENCES users(id),          -- 导入用户
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,                            -- 完成时间
    
    -- 索引
    INDEX idx_platform (platform_type),
    INDEX idx_created_at (created_at)
);
```

---

## 📤 导入原始联系人功能

### 导入流程

#### 1. 点击"导入原始联系人"按钮
弹出导入对话框

#### 2. 导入对话框内容
- **选择文件**: 上传Excel/CSV/TXT文件
- **选择平台**: Line / Line Business
- **去重范围**: 
  - 当前激活码
  - 全局
  - 自定义分组
- **文件格式说明**: 展示模板格式

#### 3. 文件格式要求

**Excel/CSV格式**:
```
| Line ID        | 显示名称  | 手机号          | 备注     |
|----------------|----------|-----------------|----------|
| @abc123        | 张三     | +886123456789   | VIP客户  |
| line123456     | 李四     |                 |          |
| @def456        | 王五     | +886987654321   | 测试     |
```

**必填字段**: Line ID
**可选字段**: 显示名称、手机号、备注

#### 4. 导入处理逻辑
```
1. 读取文件内容
2. 验证数据格式
3. 根据去重范围检查是否重复
4. 插入到contact_pool表
5. 更新import_batches统计
6. 返回导入结果
```

#### 5. 导入结果显示
```
导入完成！
- 总计：1000条
- 成功：850条
- 重复：100条
- 错误：50条

[查看详情] [关闭]
```

---

## 🔍 查看详情功能（原始联系人详细页面）

### 页面说明

**触发方式**:
- 点击"平台工单原始联系人数量"标签页中的"查看"按钮
- 跳转到原始联系人详细列表页面

**页面URL**: `/basePowderDetail?platform={platform_id}&code={activation_code}`

**示例**: `/basePowderDetail?platform=6&code=2nXZMRbA`

### 筛选功能

#### 筛选条件

**1. 时间范围筛选**
- **字段**: `created_at`
- **类型**: 日期范围选择器
- **显示**: 
  ```
  [开始时间] ~ [截止时间]
  ```

**2. 用户名搜索**
- **字段**: `line_id` 或 `display_name`
- **类型**: 文本输入框
- **占位符**: "用户名"
- **匹配方式**: 模糊搜索

**3. 手机号搜索**
- **字段**: `phone_number`
- **类型**: 文本输入框
- **占位符**: "手机号"
- **匹配方式**: 模糊搜索

**筛选操作按钮**:
```
[🔍 搜索]  [🔄 重选]
```

### 列表字段定义

| 序号 | 字段名 | 说明 |
|-----|--------|------|
| 1 | ☑ | 复选框 |
| 2 | 原始联系人ID | Line User ID |
| 3 | 原始联系人用户名 | Line显示名称或ID |
| 4 | 原始联系人手机号 | 绑定的手机号 |
| 5 | 原始联系人来源 | 数据来源 |
| 6 | 创建时间 | 添加到底库的时间 |

### 字段详细说明

#### 1. 原始联系人ID
- **字段名**: `line_id`
- **类型**: `VARCHAR(100)`
- **说明**: Line平台的User ID（唯一标识）
- **显示方式**: 文字

**示例**:
```
U2f6b817a2d757a179406da03f5ef9617
U2d06be178d70a526a125bbb52d949502
Ue7328a941e107dc0ef1934a36359f49b
```

#### 2. 原始联系人用户名
- **字段名**: `display_name`
- **类型**: `VARCHAR(100)`
- **说明**: Line显示名称，如果没有则显示Line ID
- **显示方式**: 文字

**示例**:
```
U2f6b817a2d757a179406da03f5ef9617  (没有显示名称时)
张三  (有显示名称时)
```

#### 3. 原始联系人手机号
- **字段名**: `phone_number`
- **类型**: `VARCHAR(20)`
- **说明**: 绑定的手机号码（可能为空）
- **显示方式**: 文字或空

**示例**:
```
+886123456789
（空）
```

#### 4. 原始联系人来源
- **字段名**: `source`
- **类型**: `VARCHAR(20)`
- **说明**: 该联系人的数据来源
- **可选值**:
  - `系统上报` - Windows客户端自动上报的进线
  - `手动导入` - 管理员导入的

**显示方式**:
```
系统上报
手动导入
```

#### 5. 创建时间
- **字段名**: `created_at`
- **类型**: `TIMESTAMP`
- **说明**: 该联系人首次添加到底库的时间
- **显示方式**: 日期时间格式

**示例**:
```
2025-12-21 15:49:33
2025-12-21 15:46:23
```

### 分页功能
```
共 84 条    [10条/页 ▼]  [◀] [1][2][3][4][5][6]...[9] [▶]  前往 [1] 页
```

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  📋 原始联系人详细                                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [筛选区域]                                                   │
│  ┌──────────┬──────────┬──────────┐                        │
│  │开始时间～│ 用户名   │ 手机号   │                        │
│  │截止时间  │          │          │                        │
│  └──────────┴──────────┴──────────┘                        │
│                                                               │
│  [🔍 搜索]  [🔄 重选]                                        │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [数据表格]                                                   │
│  ┌──┬────────────────┬──────────┬────────┬────────┬────────┐│
│  │☑│原始联系人ID    │用户名    │手机号  │来源    │创建时间││
│  ├──┼────────────────┼──────────┼────────┼────────┼────────┤│
│  │☐│U2f6b817a2...   │U2f6b8... │        │系统上报│15:49:33││
│  │☐│U2d06be178d...  │U2d06b... │        │系统上报│15:46:23││
│  │☐│Ue7328a941e...  │Ue7328... │        │系统上报│15:46:23││
│  │☐│Ubfb380bfd7...  │Ubfb38... │        │系统上报│15:46:22││
│  └──┴────────────────┴──────────┴────────┴────────┴────────┘│
│                                                               │
│  共 84 条  [10条/页▼] [◀][1][2][3][4][5][6]...[9][▶] 前往[1]页│
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 与进线统计的关系

### 去重逻辑

当新进线产生时，系统会根据激活码的"去重范围"设置，检查该LineID是否存在于底库中：

#### 1. 去重范围 = "当前激活码"
- 只检查当前激活码下的进线历史
- **不检查底库**

#### 2. 去重范围 = "全局"
- 检查所有激活码下的进线历史
- **同时检查底库中的所有联系人**

#### 3. 去重范围 = "账号下激活码"（参考系统特有）
- 检查账号下所有激活码的进线历史
- **同时检查底库中的联系人**

### 底库数据来源

#### 1. 手动导入
- 管理员通过"导入原始联系人"上传文件
- 批量导入历史客户数据

#### 2. 平台工单自动收集
- Windows客户端上报进线时自动添加
- 实时同步到底库

---

## 📱 页面布局

### 页面结构
```
┌─────────────────────────────────────────────────────────────┐
│  📋 底库管理（原始联系人管理）                               │
│  说明：当激活码的粉丝去重范围为"账号下激活码"时，会和底库管 │
│        理中的全部线索进行去重统计                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [统计卡片区域]                                               │
│  ┌──────────────┬──────────────┬──────────────┐            │
│  │导入原始联系人│平台工单原始  │原始联系人数量│            │
│  │数量 ℹ️       │联系人数量    │汇总          │            │
│  │   0          │   7215       │   7215       │            │
│  └──────────────┴──────────────┴──────────────┘            │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [标签页]                                                     │
│  [导入原始联系人数量] [平台工单原始联系人数量]               │
│                                                               │
│  ┌─ 导入原始联系人数量标签页 ────────────────────┐           │
│  │                                                │           │
│  │  [➕ 导入原始联系人]                          │           │
│  │                                                │           │
│  │  ┌──┬────┬──────┬────┬────┐                 │           │
│  │  │☑│平台│数量  │去重│操作│                 │           │
│  │  ├──┼────┼──────┼────┼────┤                 │           │
│  │  │  │    │      │    │    │ (暂无数据)      │           │
│  │  └──┴────┴──────┴────┴────┘                 │           │
│  └────────────────────────────────────────────┘           │
│                                                               │
│  ┌─ 平台工单原始联系人数量标签页 ─────────────────┐          │
│  │                                                │           │
│  │  [平台选择 ▼] [激活码搜索]  [🔍搜索] [🔄重选] │           │
│  │                                                │           │
│  │  ┌────────┬────┬────────┬────┬────┐          │           │
│  │  │激活码  │备注│平台    │数量│操作│          │           │
│  │  ├────────┼────┼────────┼────┼────┤          │           │
│  │  │2nXZMRbA│    │Line Bu │31  │查看│          │           │
│  │  │zsXnJbgU│大鱼│Line Bu │115 │查看│          │           │
│  │  │tqfCRQZx│33  │Line Bu │200 │查看│          │           │
│  │  └────────┴────┴────────┴────┴────┘          │           │
│  │                                                │           │
│  │  共 45 条  [10条/页▼] [◀][1][2][3][4][5][▶]  │           │
│  └────────────────────────────────────────────┘           │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 核心业务逻辑

### 1. 底库的作用
- 存储所有历史联系人数据
- 用于全局去重判断
- 支持导入外部数据源

### 2. 数据流向
```
手动导入 ──→ 底库 ←── 平台工单收集
                │
                ↓
           去重判断引擎
                │
                ↓
           进线统计
```

### 3. 去重判断流程
```
1. 新进线产生
2. 获取该激活码的去重范围设置
3. 根据去重范围查询底库
4. 判断是否重复
5. 记录进线（标记是否重复）
6. 如果不重复，添加到底库
```

---

## ✅ 已确认需求

- [x] 页面统计卡片
- [x] 两个标签页功能
- [x] 导入原始联系人功能
- [x] 平台工单列表展示
- [x] 筛选功能
- [x] 查看详情功能
- [x] 数据库表结构
- [x] 与进线统计的关系
- [x] 去重逻辑说明
- [x] 移除导出功能


