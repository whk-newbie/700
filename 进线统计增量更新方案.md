# è¿›çº¿ç»Ÿè®¡å¢é‡æ›´æ–°æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¥æœŸ**: 2025-12-21
> **è¯´æ˜**: é‡‡ç”¨å¢é‡æ›´æ–°é¿å…å®æ—¶è®¡ç®—ï¼Œé™ä½æ•°æ®åº“å‹åŠ›

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### æ ¸å¿ƒæ€è·¯
- **é¿å…å®æ—¶è®¡ç®—**: ä¸åœ¨æ¯æ¬¡æŸ¥è¯¢æ—¶JOINå’ŒCOUNT
- **å¢é‡æ›´æ–°**: å½“æœ‰æ–°è¿›çº¿æ—¶ï¼Œç›´æ¥å¯¹ç»Ÿè®¡æ•°æ® +1
- **ç¼“å­˜è¡¨**: ä½¿ç”¨ä¸“é—¨çš„ç»Ÿè®¡ç¼“å­˜è¡¨å­˜å‚¨é¢„è®¡ç®—ç»“æœ
- **å®šæ—¶æ ¡å‡†**: å®šæœŸå…¨é‡è®¡ç®—æ ¡å‡†æ•°æ®

---

## ğŸ’¾ ç»Ÿè®¡ç¼“å­˜è¡¨è®¾è®¡

### 1. group_statsï¼ˆåˆ†ç»„ç»Ÿè®¡è¡¨ï¼‰

```sql
CREATE TABLE group_stats (
    id SERIAL PRIMARY KEY,
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- è´¦å·ç»Ÿè®¡
    total_accounts INTEGER DEFAULT 0,                  -- æ€»è´¦å·æ•°
    online_accounts INTEGER DEFAULT 0,                 -- åœ¨çº¿è´¦å·æ•°
    line_accounts INTEGER DEFAULT 0,                   -- Lineå¹³å°è´¦å·æ•°
    line_business_accounts INTEGER DEFAULT 0,          -- Line Businessè´¦å·æ•°
    
    -- è¿›çº¿ç»Ÿè®¡
    today_incoming INTEGER DEFAULT 0,                  -- å½“æ—¥è¿›çº¿æ•°
    total_incoming INTEGER DEFAULT 0,                  -- æ€»è¿›çº¿æ•°
    duplicate_incoming INTEGER DEFAULT 0,              -- é‡å¤è¿›çº¿æ•°
    
    -- å½“æ—¥ç»Ÿè®¡é‡ç½®ä¿¡æ¯
    last_reset_date DATE,                              -- æœ€åé‡ç½®æ—¥æœŸ
    last_reset_time TIMESTAMP,                         -- æœ€åé‡ç½®æ—¶é—´æˆ³
    
    -- æ›´æ–°æ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE(group_id)
);

-- ç´¢å¼•
CREATE INDEX idx_group_stats_group_id ON group_stats(group_id);
```

### 2. line_account_statsï¼ˆLineè´¦å·ç»Ÿè®¡è¡¨ï¼‰

```sql
CREATE TABLE line_account_stats (
    id SERIAL PRIMARY KEY,
    line_account_id INTEGER NOT NULL REFERENCES line_accounts(id) ON DELETE CASCADE,
    
    -- è¿›çº¿ç»Ÿè®¡
    today_incoming INTEGER DEFAULT 0,                  -- å½“æ—¥è¿›çº¿æ•°
    total_incoming INTEGER DEFAULT 0,                  -- æ€»è¿›çº¿æ•°
    duplicate_incoming INTEGER DEFAULT 0,              -- é‡å¤è¿›çº¿æ•°
    
    -- å½“æ—¥ç»Ÿè®¡é‡ç½®ä¿¡æ¯
    last_reset_date DATE,                              -- æœ€åé‡ç½®æ—¥æœŸ
    last_reset_time TIMESTAMP,                         -- æœ€åé‡ç½®æ—¶é—´æˆ³
    
    -- æ›´æ–°æ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE(line_account_id)
);

-- ç´¢å¼•
CREATE INDEX idx_line_account_stats_account_id ON line_account_stats(line_account_id);
```

---

## ğŸ”„ å¢é‡æ›´æ–°é€»è¾‘

### 1. Lineè´¦å·ä¸Šçº¿/ä¸‹çº¿

**è§¦å‘æ—¶æœº**: Windowså®¢æˆ·ç«¯ä¸ŠæŠ¥è´¦å·çŠ¶æ€å˜åŒ–

**æ›´æ–°é€»è¾‘**:
```python
def update_account_status(line_account_id, new_status):
    """
    æ›´æ–°Lineè´¦å·çŠ¶æ€ï¼Œå¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    """
    # 1. æ›´æ–°Lineè´¦å·çŠ¶æ€
    account = LineAccount.query.get(line_account_id)
    old_status = account.online_status
    account.online_status = new_status
    
    # 2. å¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡ï¼ˆåªæœ‰åœ¨çº¿çŠ¶æ€å˜åŒ–æ—¶ï¼‰
    if old_status != new_status:
        group_stats = GroupStats.query.filter_by(group_id=account.group_id).first()
        
        if new_status == 'online' and old_status != 'online':
            # å˜ä¸ºåœ¨çº¿ï¼šåœ¨çº¿æ•° +1
            group_stats.online_accounts += 1
        elif new_status != 'online' and old_status == 'online':
            # å˜ä¸ºç¦»çº¿ï¼šåœ¨çº¿æ•° -1
            group_stats.online_accounts -= 1
        
        group_stats.updated_at = datetime.now()
    
    db.session.commit()
```

**ä¼˜åŠ¿**: O(1) å¤æ‚åº¦ï¼Œæ— éœ€COUNTæŸ¥è¯¢

---

### 2. æ–°å¢Lineè´¦å·

**è§¦å‘æ—¶æœº**: Windowså®¢æˆ·ç«¯åŒæ­¥è´¦å·åˆ—è¡¨ï¼Œå‘ç°æ–°è´¦å·

**æ›´æ–°é€»è¾‘**:
```python
def create_line_account(group_id, line_id, platform_type, online_status):
    """
    åˆ›å»ºLineè´¦å·ï¼Œå¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    """
    # 1. åˆ›å»ºLineè´¦å·
    account = LineAccount(
        group_id=group_id,
        line_id=line_id,
        platform_type=platform_type,
        online_status=online_status
    )
    db.session.add(account)
    
    # 2. åˆ›å»ºè´¦å·ç»Ÿè®¡è®°å½•
    account_stats = LineAccountStats(
        line_account_id=account.id,
        today_incoming=0,
        total_incoming=0,
        duplicate_incoming=0
    )
    db.session.add(account_stats)
    
    # 3. å¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    group_stats = GroupStats.query.filter_by(group_id=group_id).first()
    
    if not group_stats:
        # å¦‚æœåˆ†ç»„ç»Ÿè®¡ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        group_stats = GroupStats(group_id=group_id)
        db.session.add(group_stats)
    
    # æ€»è´¦å·æ•° +1
    group_stats.total_accounts += 1
    
    # å¹³å°è´¦å·æ•° +1
    if platform_type == 'line':
        group_stats.line_accounts += 1
    elif platform_type == 'line_business':
        group_stats.line_business_accounts += 1
    
    # å¦‚æœæ˜¯åœ¨çº¿çŠ¶æ€ï¼Œåœ¨çº¿æ•° +1
    if online_status == 'online':
        group_stats.online_accounts += 1
    
    group_stats.updated_at = datetime.now()
    
    db.session.commit()
```

---

### 3. æ–°å¢è¿›çº¿ï¼ˆæ ¸å¿ƒï¼‰

**è§¦å‘æ—¶æœº**: Windowså®¢æˆ·ç«¯ä¸ŠæŠ¥è¿›çº¿æ•°æ®

**æ›´æ–°é€»è¾‘**:
```python
def record_incoming(activation_code, line_account_line_id, incoming_line_id, **optional_data):
    """
    è®°å½•è¿›çº¿å¹¶å¢é‡æ›´æ–°ç»Ÿè®¡æ•°æ®
    """
    # 1. æ‰¾åˆ°åˆ†ç»„å’ŒLineè´¦å·
    group = Group.query.filter_by(activation_code=activation_code).first()
    line_account = LineAccount.query.filter_by(
        group_id=group.id,
        line_id=line_account_line_id
    ).first()
    
    # 2. å»é‡åˆ¤æ–­
    if group.dedup_scope == 'current':
        is_duplicate = ContactPool.query.filter_by(
            group_id=group.id,
            line_id=incoming_line_id
        ).first() is not None
    else:  # 'global'
        is_duplicate = ContactPool.query.filter_by(
            line_id=incoming_line_id
        ).first() is not None
    
    # 3. è®°å½•è¿›çº¿æ—¥å¿—
    log = IncomingLog(
        line_account_id=line_account.id,
        incoming_line_id=incoming_line_id,
        is_duplicate=is_duplicate,
        incoming_time=datetime.now()
    )
    db.session.add(log)
    
    # 4. å¢é‡æ›´æ–°Lineè´¦å·ç»Ÿè®¡
    account_stats = LineAccountStats.query.filter_by(
        line_account_id=line_account.id
    ).first()
    
    if not account_stats:
        account_stats = LineAccountStats(line_account_id=line_account.id)
        db.session.add(account_stats)
    
    account_stats.total_incoming += 1  # æ€»è¿›çº¿ +1
    account_stats.today_incoming += 1  # å½“æ—¥è¿›çº¿ +1
    
    if is_duplicate:
        account_stats.duplicate_incoming += 1  # é‡å¤è¿›çº¿ +1
    
    account_stats.updated_at = datetime.now()
    
    # 5. å¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    group_stats = GroupStats.query.filter_by(group_id=group.id).first()
    
    if not group_stats:
        group_stats = GroupStats(group_id=group.id)
        db.session.add(group_stats)
    
    group_stats.total_incoming += 1  # æ€»è¿›çº¿ +1
    group_stats.today_incoming += 1  # å½“æ—¥è¿›çº¿ +1
    
    if is_duplicate:
        group_stats.duplicate_incoming += 1  # é‡å¤è¿›çº¿ +1
    
    group_stats.updated_at = datetime.now()
    
    # 6. æ·»åŠ åˆ°åº•åº“ï¼ˆå¦‚æœä¸é‡å¤ï¼‰
    if not is_duplicate:
        contact = ContactPool(
            group_id=group.id,
            line_id=incoming_line_id,
            source_type='platform',
            platform_type=line_account.platform_type
        )
        db.session.add(contact)
    
    db.session.commit()
    
    # 7. WebSocketæ¨é€æ›´æ–°
    push_stats_update(group.id, line_account.id)
    
    return is_duplicate
```

**ä¼˜åŠ¿**:
- åªéœ€è¦ç®€å•çš„ +1 æ“ä½œ
- æ— éœ€å¤æ‚çš„JOINå’ŒCOUNT
- æ€§èƒ½ç¨³å®šï¼Œä¸å—æ•°æ®é‡å½±å“

---

### 4. åˆ é™¤Lineè´¦å·

**è§¦å‘æ—¶æœº**: ç®¡ç†å‘˜åˆ é™¤Lineè´¦å·

**æ›´æ–°é€»è¾‘**:
```python
def delete_line_account(line_account_id):
    """
    åˆ é™¤Lineè´¦å·ï¼Œå¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    """
    account = LineAccount.query.get(line_account_id)
    
    # 1. å¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡
    group_stats = GroupStats.query.filter_by(group_id=account.group_id).first()
    
    # æ€»è´¦å·æ•° -1
    group_stats.total_accounts -= 1
    
    # å¹³å°è´¦å·æ•° -1
    if account.platform_type == 'line':
        group_stats.line_accounts -= 1
    elif account.platform_type == 'line_business':
        group_stats.line_business_accounts -= 1
    
    # å¦‚æœæ˜¯åœ¨çº¿çŠ¶æ€ï¼Œåœ¨çº¿æ•° -1
    if account.online_status == 'online':
        group_stats.online_accounts -= 1
    
    # 2. è½¯åˆ é™¤è´¦å·ï¼ˆä¸çœŸåˆ é™¤ï¼Œä¿ç•™å†å²æ•°æ®ï¼‰
    account.deleted_at = datetime.now()
    
    db.session.commit()
```

---

## â° æ¯æ—¥é‡ç½®ä»»åŠ¡

### ç½®é›¶æ—¶é—´å¤„ç†

**ä»»åŠ¡**: æ¯åˆ†é’Ÿæ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç»„éœ€è¦é‡ç½®

```python
from apscheduler.schedulers.background import BackgroundScheduler

def check_and_reset_daily_stats():
    """
    æ£€æŸ¥å¹¶é‡ç½®åˆ°è¾¾ç½®é›¶æ—¶é—´çš„åˆ†ç»„ç»Ÿè®¡
    """
    now = datetime.now()
    current_time = now.time()
    current_date = now.date()
    
    # æŸ¥æ‰¾éœ€è¦é‡ç½®çš„åˆ†ç»„
    # æ¡ä»¶ï¼š
    # 1. å½“å‰æ—¶é—´åˆšå¥½ç»è¿‡reset_timeï¼ˆè¯¯å·®1åˆ†é’Ÿå†…ï¼‰
    # 2. ä»Šå¤©è¿˜æ²¡é‡ç½®è¿‡
    
    groups_to_reset = Group.query.filter(
        Group.is_active == True
    ).all()
    
    for group in groups_to_reset:
        # è®¡ç®—ä»Šå¤©çš„é‡ç½®æ—¶é—´ç‚¹
        reset_datetime = datetime.combine(current_date, group.reset_time)
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
        # 1. å½“å‰æ—¶é—´å·²è¿‡é‡ç½®æ—¶é—´
        # 2. æœ€åé‡ç½®æ—¥æœŸä¸æ˜¯ä»Šå¤©
        group_stats = GroupStats.query.filter_by(group_id=group.id).first()
        
        if (now >= reset_datetime and 
            (group_stats.last_reset_date is None or group_stats.last_reset_date < current_date)):
            
            # é‡ç½®åˆ†ç»„çš„å½“æ—¥ç»Ÿè®¡
            group_stats.today_incoming = 0
            group_stats.last_reset_date = current_date
            group_stats.last_reset_time = now
            
            # é‡ç½®è¯¥åˆ†ç»„ä¸‹æ‰€æœ‰Lineè´¦å·çš„å½“æ—¥ç»Ÿè®¡
            LineAccountStats.query.filter(
                LineAccountStats.line_account_id.in_(
                    db.session.query(LineAccount.id).filter(
                        LineAccount.group_id == group.id
                    )
                )
            ).update({
                'today_incoming': 0,
                'last_reset_date': current_date,
                'last_reset_time': now
            }, synchronize_session=False)
            
            db.session.commit()
            
            print(f"åˆ†ç»„ {group.activation_code} å·²é‡ç½®å½“æ—¥ç»Ÿè®¡")

# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
scheduler = BackgroundScheduler()
scheduler.add_job(check_and_reset_daily_stats, 'cron', minute='*')
scheduler.start()
```

**ä¼˜åŠ¿**:
- ç²¾ç¡®æ§åˆ¶é‡ç½®æ—¶é—´
- æ¯ä¸ªåˆ†ç»„ç‹¬ç«‹é‡ç½®
- ä¸å½±å“æ€»è¿›çº¿ç»Ÿè®¡

---

## ğŸ“Š æŸ¥è¯¢ä¼˜åŒ–åçš„SQL

### çº¿ç´¢åˆ—è¡¨æŸ¥è¯¢ï¼ˆä¸å†éœ€è¦å¤æ‚JOINï¼‰

```sql
-- ç®€åŒ–ç‰ˆæŸ¥è¯¢ï¼Œç›´æ¥è¯»å–ç»Ÿè®¡è¡¨
SELECT 
    g.id,
    g.activation_code,
    g.is_active,
    g.remark,
    g.description,
    g.dedup_scope,
    g.created_at,
    g.last_login_at,
    g.reset_time,
    g.account_limit,
    
    -- ç›´æ¥ä»ç»Ÿè®¡è¡¨è¯»å–
    COALESCE(gs.total_accounts, 0) as total_accounts,
    COALESCE(gs.online_accounts, 0) as online_accounts,
    COALESCE(gs.line_accounts, 0) as line_accounts,
    COALESCE(gs.line_business_accounts, 0) as line_business_accounts,
    COALESCE(gs.today_incoming, 0) as today_incoming,
    COALESCE(gs.total_incoming, 0) as total_incoming,
    COALESCE(gs.duplicate_incoming, 0) as duplicate_incoming

FROM groups g
LEFT JOIN group_stats gs ON gs.group_id = g.id

WHERE g.deleted_at IS NULL

ORDER BY g.created_at DESC;
```

**æ€§èƒ½æå‡**:
- ä» O(n*m) å¤æ‚åº¦é™ä½åˆ° O(1)
- æ— éœ€JOIN line_accountså’Œincoming_logs
- æŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œä¸å—æ•°æ®é‡å½±å“

---

### Lineè´¦å·åˆ—è¡¨æŸ¥è¯¢ï¼ˆå±•å¼€åï¼‰

```sql
-- æŸ¥è¯¢æŸä¸ªåˆ†ç»„ä¸‹æ‰€æœ‰Lineè´¦å·åŠå…¶ç»Ÿè®¡
SELECT 
    la.id,
    la.line_id,
    la.display_name,
    la.platform_type,
    la.online_status,
    la.last_online_time,
    
    -- ç›´æ¥ä»ç»Ÿè®¡è¡¨è¯»å–
    COALESCE(las.today_incoming, 0) as today_incoming,
    COALESCE(las.total_incoming, 0) as total_incoming,
    COALESCE(las.duplicate_incoming, 0) as duplicate_incoming

FROM line_accounts la
LEFT JOIN line_account_stats las ON las.line_account_id = la.id

WHERE la.group_id = {group_id} 
  AND la.deleted_at IS NULL

ORDER BY 
    CASE WHEN la.online_status = 'online' THEN 1 ELSE 2 END,
    las.total_incoming DESC;
```

---

## ğŸš€ åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®

### åˆ›å»ºåˆ†ç»„æ—¶åˆå§‹åŒ–

```python
def create_group(user_id, remark, **kwargs):
    """
    åˆ›å»ºåˆ†ç»„å¹¶åˆå§‹åŒ–ç»Ÿè®¡è¡¨
    """
    # 1. åˆ›å»ºåˆ†ç»„
    group = Group(
        created_by=user_id,
        activation_code=generate_activation_code(),
        remark=remark,
        ...
    )
    db.session.add(group)
    db.session.flush()  # è·å–group.id
    
    # 2. åˆå§‹åŒ–ç»Ÿè®¡è¡¨
    group_stats = GroupStats(
        group_id=group.id,
        total_accounts=0,
        online_accounts=0,
        line_accounts=0,
        line_business_accounts=0,
        today_incoming=0,
        total_incoming=0,
        duplicate_incoming=0
    )
    db.session.add(group_stats)
    
    db.session.commit()
    return group
```

### åˆ›å»ºLineè´¦å·æ—¶åˆå§‹åŒ–

```python
def create_line_account(group_id, line_id, platform_type, online_status):
    """
    åˆ›å»ºLineè´¦å·å¹¶åˆå§‹åŒ–ç»Ÿè®¡è¡¨
    """
    # 1. åˆ›å»ºLineè´¦å·
    account = LineAccount(
        group_id=group_id,
        line_id=line_id,
        platform_type=platform_type,
        online_status=online_status
    )
    db.session.add(account)
    db.session.flush()
    
    # 2. åˆå§‹åŒ–è´¦å·ç»Ÿè®¡è¡¨
    account_stats = LineAccountStats(
        line_account_id=account.id,
        today_incoming=0,
        total_incoming=0,
        duplicate_incoming=0
    )
    db.session.add(account_stats)
    
    # 3. å¢é‡æ›´æ–°åˆ†ç»„ç»Ÿè®¡ï¼ˆå¦‚å‰æ‰€è¿°ï¼‰
    update_group_stats_on_account_created(group_id, platform_type, online_status)
    
    db.session.commit()
    return account
```

---

## ğŸ”§ æ•°æ®æ ¡å‡†æœºåˆ¶

### å®šæœŸå…¨é‡æ ¡å‡†

**åœºæ™¯**: é˜²æ­¢å› å¼‚å¸¸å¯¼è‡´ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®

**ä»»åŠ¡**: æ¯å¤©å‡Œæ™¨3ç‚¹å…¨é‡é‡ç®—æ‰€æœ‰ç»Ÿè®¡æ•°æ®

```python
def recalculate_all_stats():
    """
    å…¨é‡é‡ç®—æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼‰
    """
    print("å¼€å§‹å…¨é‡æ ¡å‡†ç»Ÿè®¡æ•°æ®...")
    
    # 1. é‡ç®—æ‰€æœ‰åˆ†ç»„çš„ç»Ÿè®¡
    groups = Group.query.filter_by(deleted_at=None).all()
    
    for group in groups:
        # æŸ¥è¯¢è¯¥åˆ†ç»„çš„å®é™…æ•°æ®
        accounts = LineAccount.query.filter_by(
            group_id=group.id,
            deleted_at=None
        ).all()
        
        total_accounts = len(accounts)
        online_accounts = sum(1 for a in accounts if a.online_status == 'online')
        line_accounts = sum(1 for a in accounts if a.platform_type == 'line')
        line_business_accounts = sum(1 for a in accounts if a.platform_type == 'line_business')
        
        # è®¡ç®—ä»Šæ—¥é‡ç½®æ—¶é—´
        today_reset = datetime.combine(date.today(), group.reset_time)
        if datetime.now() < today_reset:
            today_reset = today_reset - timedelta(days=1)
        
        # ç»Ÿè®¡è¿›çº¿æ•°æ®
        account_ids = [a.id for a in accounts]
        
        total_incoming = IncomingLog.query.filter(
            IncomingLog.line_account_id.in_(account_ids)
        ).count()
        
        today_incoming = IncomingLog.query.filter(
            IncomingLog.line_account_id.in_(account_ids),
            IncomingLog.incoming_time >= today_reset
        ).count()
        
        duplicate_incoming = IncomingLog.query.filter(
            IncomingLog.line_account_id.in_(account_ids),
            IncomingLog.is_duplicate == True
        ).count()
        
        # æ›´æ–°ç»Ÿè®¡è¡¨
        group_stats = GroupStats.query.filter_by(group_id=group.id).first()
        if not group_stats:
            group_stats = GroupStats(group_id=group.id)
            db.session.add(group_stats)
        
        group_stats.total_accounts = total_accounts
        group_stats.online_accounts = online_accounts
        group_stats.line_accounts = line_accounts
        group_stats.line_business_accounts = line_business_accounts
        group_stats.total_incoming = total_incoming
        group_stats.today_incoming = today_incoming
        group_stats.duplicate_incoming = duplicate_incoming
        group_stats.updated_at = datetime.now()
    
    # 2. é‡ç®—æ‰€æœ‰Lineè´¦å·çš„ç»Ÿè®¡ï¼ˆç±»ä¼¼é€»è¾‘ï¼‰
    # ...
    
    db.session.commit()
    print("ç»Ÿè®¡æ•°æ®æ ¡å‡†å®Œæˆ")

# å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
scheduler.add_job(recalculate_all_stats, 'cron', hour=3, minute=0)
```

**é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡ï¼ˆå‡Œæ™¨3ç‚¹ï¼‰

**ç›®çš„**:
- ä¿®æ­£å¯èƒ½çš„æ•°æ®ä¸ä¸€è‡´
- é˜²æ­¢é•¿æœŸç´¯ç§¯è¯¯å·®
- æ•°æ®åº“å‹åŠ›å°ï¼ˆéé«˜å³°æœŸæ‰§è¡Œï¼‰

---

## ğŸ“ˆ Redisç¼“å­˜ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### å®æ—¶ç»Ÿè®¡ç¼“å­˜

**åœºæ™¯**: è¿›ä¸€æ­¥é™ä½æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

**æ–¹æ¡ˆ**: å°†ç»Ÿè®¡æ•°æ®åŒæ—¶ç¼“å­˜åˆ°Redis

```python
# å¢é‡æ›´æ–°æ—¶ï¼ŒåŒæ­¥æ›´æ–°Redis
def update_stats_with_cache(group_id, line_account_id):
    """
    æ›´æ–°PostgreSQLç»Ÿè®¡è¡¨çš„åŒæ—¶æ›´æ–°Redisç¼“å­˜
    """
    # 1. æ›´æ–°PostgreSQLï¼ˆå¦‚å‰æ‰€è¿°ï¼‰
    update_postgres_stats(group_id, line_account_id)
    
    # 2. åŒæ­¥æ›´æ–°Redisç¼“å­˜
    redis_key = f"group_stats:{group_id}"
    redis.hincrby(redis_key, "today_incoming", 1)
    redis.hincrby(redis_key, "total_incoming", 1)
    redis.expire(redis_key, 3600)  # 1å°æ—¶è¿‡æœŸï¼Œå¼ºåˆ¶ä»DBåˆ·æ–°
```

**æŸ¥è¯¢æ—¶ä¼˜å…ˆä»Redisè¯»å–**:
```python
def get_group_stats(group_id):
    """
    è·å–åˆ†ç»„ç»Ÿè®¡ï¼Œä¼˜å…ˆä»Redisè¯»å–
    """
    redis_key = f"group_stats:{group_id}"
    cached = redis.hgetall(redis_key)
    
    if cached:
        # ä»ç¼“å­˜è¯»å–
        return cached
    else:
        # ä»æ•°æ®åº“è¯»å–
        stats = GroupStats.query.filter_by(group_id=group_id).first()
        
        # å†™å…¥ç¼“å­˜
        if stats:
            redis.hmset(redis_key, {
                "total_accounts": stats.total_accounts,
                "online_accounts": stats.online_accounts,
                "today_incoming": stats.today_incoming,
                "total_incoming": stats.total_incoming,
                ...
            })
            redis.expire(redis_key, 3600)
        
        return stats
```

**ä¼˜åŠ¿**:
- æŸ¥è¯¢é€Ÿåº¦æ›´å¿«
- è¿›ä¸€æ­¥é™ä½æ•°æ®åº“å‹åŠ›
- é€‚åˆé«˜å¹¶å‘åœºæ™¯

---

## ğŸ¯ æ€§èƒ½å¯¹æ¯”

### å®æ—¶è®¡ç®—æ–¹æ¡ˆï¼ˆåŸæ–¹æ¡ˆï¼‰

```sql
-- æ¯æ¬¡æŸ¥è¯¢éƒ½è¦æ‰§è¡Œ
SELECT 
    g.id,
    COUNT(CASE WHEN la.online_status = 'online' THEN 1 END) as online_count,
    COUNT(*) as total_count,
    ...
FROM groups g
LEFT JOIN line_accounts la ON la.group_id = g.id
LEFT JOIN incoming_logs il ON il.line_account_id = la.id
GROUP BY g.id;
```

**æ€§èƒ½é—®é¢˜**:
- æŸ¥è¯¢å¤æ‚åº¦: O(n*m)ï¼ˆn=è´¦å·æ•°, m=è¿›çº¿æ•°ï¼‰
- å¤§æ•°æ®é‡æ—¶æŸ¥è¯¢ç¼“æ…¢
- é«˜å¹¶å‘æ—¶æ•°æ®åº“å‹åŠ›å¤§

### å¢é‡æ›´æ–°æ–¹æ¡ˆï¼ˆæ–°æ–¹æ¡ˆï¼‰

```sql
-- ç®€å•æŸ¥è¯¢
SELECT 
    g.*,
    gs.*
FROM groups g
LEFT JOIN group_stats gs ON gs.group_id = g.id;
```

**æ€§èƒ½ä¼˜åŠ¿**:
- æŸ¥è¯¢å¤æ‚åº¦: O(1)
- æŸ¥è¯¢é€Ÿåº¦ç¨³å®š
- æ•°æ®åº“å‹åŠ›å°

**æƒè¡¡**:
- éœ€è¦é¢å¤–çš„ç»Ÿè®¡è¡¨
- éœ€è¦ç»´æŠ¤ç»Ÿè®¡æ•°æ®ä¸€è‡´æ€§
- éœ€è¦å®šæœŸæ ¡å‡†

---

## âœ… å®æ–½è¦ç‚¹

### å¿…é¡»å®ç°
1. âœ… åˆ›å»ºç»Ÿè®¡ç¼“å­˜è¡¨ï¼ˆgroup_statsã€line_account_statsï¼‰
2. âœ… æ‰€æœ‰å¢é‡æ›´æ–°é€»è¾‘
3. âœ… æ¯æ—¥é‡ç½®ä»»åŠ¡
4. âœ… å®šæœŸæ ¡å‡†ä»»åŠ¡

### å¯é€‰ä¼˜åŒ–
1. â­ Redisç¼“å­˜ï¼ˆæ¨èï¼‰
2. â­ ç»Ÿè®¡æ•°æ®ç‰ˆæœ¬å·ï¼ˆé˜²æ­¢å¹¶å‘å†²çªï¼‰
3. â­ ç»Ÿè®¡æ•°æ®å¿«ç…§ï¼ˆå†å²è¶‹åŠ¿åˆ†æï¼‰

### æ³¨æ„äº‹é¡¹
1. ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
2. å¢é‡æ›´æ–°å’Œè®°å½•æ—¥å¿—åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
3. å®šæœŸæ ¡å‡†é˜²æ­¢æ•°æ®æ¼‚ç§»
4. ç›‘æ§ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§

---

## âœ… å·²ç¡®è®¤éœ€æ±‚

- [x] é‡‡ç”¨å¢é‡æ›´æ–°æ–¹æ¡ˆ
- [x] åˆ›å»ºç»Ÿè®¡ç¼“å­˜è¡¨
- [x] é¿å…å®æ—¶è®¡ç®—
- [x] è¿›çº¿æ—¶å¢é‡æ›´æ–°
- [x] è´¦å·ä¸Šä¸‹çº¿æ—¶å¢é‡æ›´æ–°
- [x] æ¯æ—¥é‡ç½®ä»»åŠ¡
- [x] å®šæœŸæ ¡å‡†ä»»åŠ¡
- [x] Redisç¼“å­˜ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰


