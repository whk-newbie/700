# Line账号管理系统 - 需求汇总文档

> **版本**: v2.0
> **更新日期**: 2025-12-21
> **说明**: 基于CEO SCRM系统重新设计的完整需求汇总

---

## 📚 需求文档列表

本系统包含以下需求文档：

1. [用户权限体系设计.md](用户权限体系设计.md) - 三层权限结构
2. [Windows客户端交互协议.md](Windows客户端交互协议.md) - 客户端通信协议
3. [进线统计与去重逻辑.md](进线统计与去重逻辑.md) - 去重和统计规则
4. [进线统计增量更新方案.md](进线统计增量更新方案.md) - 性能优化方案
5. [分组管理需求方案.md](分组管理需求方案.md) - 激活码/分组管理
6. [账号列表需求方案.md](账号列表需求方案.md) - Line账号管理
7. [线索列表需求方案.md](线索列表需求方案.md) - 总看板/进线统计
8. [底库管理需求方案.md](底库管理需求方案.md) - 原始联系人底库
9. [客户列表需求方案.md](客户列表需求方案.md) - 客户信息管理
10. [跟进记录需求方案.md](跟进记录需求方案.md) - 跟进记录管理
11. [用户管理需求方案.md](用户管理需求方案.md) - 用户管理（管理员专用）
12. [大模型API代理需求方案.md](大模型API代理需求方案.md) - 大模型调用代理（管理员专用）
13. [技术选型方案-Go vs Python.md](技术选型方案-Go vs Python.md) - 技术选型
14. [数据库表设计-完整版.md](数据库表设计-完整版.md) - 数据库设计（14张表）
15. [项目实施规划.md](项目实施规划.md) - 开发计划

---

## 🎯 系统概述

### 核心功能
Line账号分组管理系统，用于管理多个分组（激活码），每个分组包含多个Line账号，支持在线监控、进线统计、去重管理、客户管理等功能。

### 技术栈
- **后端**: FastAPI + PostgreSQL + Redis
- **前端**: Vue3 + Element Plus
- **实时通信**: WebSocket
- **部署**: Docker + Nginx

---

## 👥 用户角色与权限

### 三层权限结构

```
管理员
  ├─ 普通用户A
  │    ├─ 分组1（激活码ABC123）= 子账号1
  │    ├─ 分组2（激活码DEF456）= 子账号2
  │    └─ 分组3（激活码GHI789）= 子账号3
  │
  └─ 普通用户B
       ├─ 分组1（激活码XYZ111）= 子账号1
       └─ 分组2（激活码XYZ222）= 子账号2
```

### 权限对比表

| 角色 | 数据范围 | 可访问页面 | 操作权限 |
|-----|---------|-----------|---------|
| **管理员** | 所有数据 | 全部页面 + 用户管理 + 系统配置 | 完全权限 |
| **普通用户** | 自己创建的所有分组 | 分组管理、账号列表、线索列表、底库管理、客户列表、跟进记录 | 完全权限（自己的数据） |
| **子账号（分组）** | 仅自己分组的数据 | 账号列表、线索列表、底库管理、客户列表、跟进记录 | 完全权限（自己分组的数据），但不能创建新分组，可以删除自己的分组 |

### 登录方式

| 角色 | 登录方式 |
|-----|---------|
| 管理员 | 用户名 + 密码 |
| 普通用户 | 用户名 + 密码 |
| 子账号 | 激活码 + 密码（可选） |

---

## 🗂️ 核心页面与功能

### 1. 分组管理（激活码列表）

**功能**: 管理所有分组（激活码）

**核心字段**:
- 激活码、占用/分配、在线/总账号、启用状态、备注信息、说明、去重范围、创建时间/最近登录、置零时间、分组归类

**核心功能**:
- 筛选：时间、激活码、备注、启用状态
- 激活码分组管理
- 新增激活码
- 批量操作：禁用/启用、修改置零时间、修改去重范围、分组归类、删除
- 查看、禁用操作

---

### 2. 账号列表

**功能**: 展示所有Line账号详情

**核心字段**:
- 序号、主账号详情（显示名+LineID）、手机号、在线状态、所属激活码、备注、首登/最后活跃时间、主页地址、二维码

**核心功能**:
- 平台筛选：Line、Line Business
- 筛选：所属激活码、用户名/账号ID、在线状态
- 批量操作：移除账号、强制下线
- 日志记录：查看账号上下线日志

**新增字段**:
- `platform_type`: line / line_business（默认line）

---

### 3. 线索列表（总看板）

**功能**: 总看板，展示所有分组的统计信息和进线数据

**核心字段**:
- 激活码、启用状态、占用/分配、在线/总账号、备注、说明、Line、Line Business、**当日进线**、**总进线**、**重复进线**、去重范围、创建时间/最近登录

**核心功能**:
- 筛选：时间、激活码、备注、启用状态
- 激活码分组、新增激活码
- 批量操作：禁用/启用、修改置零时间、修改去重范围、分组归类
- **展开/折叠**: 展开显示该分组下所有Line账号的详细列表和进线统计

**进线统计**:
- 分组级别：当日进线、总进线、重复进线
- Line账号级别（展开后）：当日进线、总进线、重复进线

---

### 4. 底库管理

**功能**: 管理原始联系人底库，用于去重判断

**两个标签页**:
1. **导入原始联系人数量**: 手动导入的联系人
2. **平台工单原始联系人数量**: 系统自动收集的联系人

**核心功能**:
- 导入原始联系人（Excel/CSV/TXT）
- 查看详细联系人列表
- 筛选：平台、激活码、时间、用户名、手机号

**字段**:
- 激活码、备注、平台、原始联系人数量
- 详情：原始联系人ID、用户名、手机号、来源（系统上报/手动导入）、创建时间

**去重作用**:
- 分组设置去重范围后，新进线会与底库对比判断是否重复

---

### 5. 客户列表

**功能**: 管理客户信息（全局去重的进线日志）

**核心字段**:
- 序号、激活码、客户信息、用户昵称、手机号、所属社交账号、备注、客户类型、国家、添加时间、更新时间

**核心功能**:
- 平台筛选：Line、Line Business
- 筛选：时间、激活码、国家、性别、客户类型
- 跟进记录按钮
- 查看客户详情（站内页面）

**客户类型**:
- 新增线索-实时
- 新增线索-补录
- 新增线索-重复
- 新增线索-导入重复

**客户详情页面**:
- 只读：账号信息、所属社交账号、客户ID
- 可编辑：手机号、昵称备注、性别、国家、生日、地址、标签、备注

**说明**: 客户列表始终使用全局去重，作为全局进线日志

---

### 6. 跟进记录

**功能**: 记录线索的跟进情况

**核心字段**:
- 激活码、主账号信息、主账号、线索账号信息、线索账号、创建日期、内容

**核心功能**:
- 筛选：时间、APP（平台）、激活码
- 查看跟进记录
- 编辑跟进内容
- 删除跟进记录
- 从客户列表批量添加跟进记录

---

## 💻 Windows客户端

### 核心功能

1. **多激活码支持**
   - 一个客户端可以登录多个激活码
   - 每个激活码独立WebSocket连接
   - 数据通过激活码+LineID归属

2. **Line账号自动发现**
   - 扫描本地登录的Line账号
   - 自动上报账号列表到服务器

3. **在线状态监控**
   - 保持WebSocket连接 = 在线
   - 断开连接 = 离线
   - 心跳机制（60秒/次）

4. **数据上报**
   - Line账号列表同步
   - 进线数据上报
   - 客户信息上报
   - 跟进记录上报

### 通信协议

- **HTTP**: 登录认证、批量数据上传
- **WebSocket**: 实时数据上报、心跳保持

### 数据归属

**关键**: 通过 `激活码 + Line ID` 确定数据归属

```
激活码ABC123 + Line账号@line001 → 分组1的Line账号
激活码ABC123 + Line账号@line001 + 进线U123 → 分组1的进线记录
```

---

## 🔄 去重逻辑

### 两种去重范围

| 去重范围 | 说明 | 检查范围 |
|---------|------|---------|
| 当前激活码 | 本分组去重 | 只检查本分组的底库 |
| 全局 | 跨所有分组去重 | 检查所有分组的底库 |

### 特殊说明

- **线索列表**: 根据分组设置的去重范围判断
- **客户列表**: 始终使用全局去重（作为全局进线日志）

---

## 📊 数据库核心表

### 1. users（用户表）
- 管理员和普通用户

### 2. groups（分组表）
- 每个分组对应一个激活码
- 每个分组也是一个子账号
- 字段：activation_code、account_limit、is_active、remark、description、dedup_scope、reset_time、login_password

### 3. line_accounts（Line账号表）
- 每个Line账号归属于一个分组
- 字段：group_id、activation_code、platform_type、line_id、display_name、phone_number、online_status、profile_url、qr_code_url

### 4. incoming_logs（进线记录表）
- 记录所有进线
- 字段：line_account_id、incoming_line_id、incoming_time、is_duplicate

### 5. contact_pool（原始联系人底库表）
- 存储所有联系人（用于去重）
- 字段：group_id、platform_type、line_id、display_name、source_type

### 6. customers（客户表）
- 全局客户列表（进线日志）
- 字段：group_id、line_account_id、customer_id、display_name、phone_number、customer_type、gender、country

### 7. follow_up_records（跟进记录表）
- 客户跟进记录
- 字段：group_id、line_account_id、customer_id、content、created_at

### 8. account_status_logs（账号状态日志表）
- Line账号上下线日志
- 字段：line_account_id、from_status、to_status、reason、occurred_at

### 9. import_batches（导入批次表）
- 记录手动导入的批次信息
- 字段：batch_name、platform_type、total_count、file_name

---

## 🔄 核心数据流

### 1. Line账号同步流程
```
Windows客户端扫描本地Line
  ↓
通过WebSocket上报账号列表（带activation_code）
  ↓
服务器根据activation_code找到分组
  ↓
创建或更新Line账号记录（关联到该分组）
  ↓
自动生成二维码
  ↓
返回同步结果
```

### 2. 进线数据流程
```
Line账号收到新好友申请
  ↓
Windows客户端检测到进线
  ↓
上报进线数据（activation_code + line_account_id + incoming_line_id）
  ↓
服务器根据activation_code + line_account_id找到Line账号
  ↓
根据分组的去重范围检查底库
  ↓
判断是否重复
  ↓
记录进线日志（标记is_duplicate）
  ↓
更新统计数据
  ↓
如果不重复，添加到底库
  ↓
WebSocket推送更新到前端
```

### 3. 客户信息流程
```
Windows客户端为客户添加画像
  ↓
上报客户信息（activation_code + line_account_id + customer_id + 详细信息）
  ↓
服务器创建或更新客户记录
  ↓
客户类型标记为"新增线索-实时"（如果是首次）或"新增线索-重复"（如果已存在）
  ↓
更新客户列表
```

---

## 🎨 前端页面结构

### 管理员菜单
```
├─ 首页
├─ 分组管理（激活码列表）
├─ 账号列表
├─ 线索列表（总看板）
├─ 底库管理
├─ 客户列表
├─ 跟进记录
├─ 系统管理
│   ├─ 用户管理
│   ├─ 大模型配置
│   └─ 大模型调用记录
└─ 个人中心
```

### 普通用户菜单
```
├─ 首页
├─ 分组管理（只看自己的分组）
├─ 账号列表（只看自己的账号）
├─ 线索列表（只看自己的线索）
├─ 底库管理（只看自己的底库）
├─ 客户列表（只看自己的客户）
├─ 跟进记录（只看自己的记录）
└─ 个人中心
```

### 子账号菜单
```
├─ 首页
├─ 账号列表（只看自己分组）
├─ 线索列表（只看自己分组）
├─ 底库管理（只看自己分组）
├─ 客户列表（只看自己分组）
├─ 跟进记录（只看自己分组）
└─ 个人中心
```

**权限说明**:
- **大模型配置**: 仅管理员可见
- **大模型调用记录**: 仅管理员可见
- **用户管理**: 仅管理员可见
- **分组管理**: 子账号不可见（因为只有一个分组）

---

## 🔑 关键设计要点

### 1. 分组与子账号
- **分组 = 激活码 = 子账号**（一对一关系）
- 普通用户创建分组时，自动生成激活码
- 该激活码可用于：
  - Windows客户端登录
  - 子账号登录后台

### 2. 数据归属
- 所有数据通过 `激活码 + Line ID` 确定归属
- Windows客户端上报时必须携带 `activation_code`
- 服务器通过激活码找到分组，再找到具体的Line账号

### 3. 去重机制
- **线索统计**: 根据分组的去重范围设置（当前激活码/全局）
- **客户列表**: 始终全局去重
- **底库**: 存储所有联系人，用于去重判断

### 4. 在线判断
- Windows客户端的WebSocket连接状态 = Line账号在线状态
- 心跳超时（65秒）= 异常离线

### 5. 置零时间
- 每个分组独立设置置零时间
- 到达置零时间后，清空该分组的当日进线统计

---

## 📊 统计数据说明

### 线索列表统计（分组级别）
- **占用/分配**: 在线账号数 / 账号上限（null=不限制）
- **在线/总账号**: 在线账号数 / 总账号数
- **Line**: Line平台账号数
- **Line Business**: Line Business平台账号数
- **当日进线**: 今日进线总数（从置零时间开始）
- **总进线**: 历史进线总数
- **重复进线**: 重复进线数

### 展开后统计（Line账号级别）
- **在线状态**: 在线/离线/异常离线
- **当日进线**: 该账号今日进线数
- **总进线**: 该账号历史进线数
- **重复进线**: 该账号重复进线数

---

## 🚀 开发优先级建议

### 阶段一：基础架构（第1-2周）
1. 数据库设计与创建
2. 用户认证系统（三种登录方式）
3. 权限控制系统

### 阶段二：核心功能（第3-6周）
4. 分组管理模块
5. Line账号管理模块
6. WebSocket服务（在线监控）

### 阶段三：进线统计（第7-8周）
7. 进线数据上报处理
8. 去重逻辑实现
9. 线索列表（总看板）
10. 底库管理

### 阶段四：客户管理（第9-10周）
11. 客户列表
12. 客户详情
13. 跟进记录

### 阶段五：Windows客户端对接（第11-12周）
14. WebSocket协议实现
15. 数据上报处理
16. 心跳机制
17. 客户端对接测试

### 阶段六：优化与测试（第13-14周）
18. 性能优化
19. 实时推送优化
20. 完整功能测试

---

## ✅ 已确认的核心需求

- [x] 三层权限体系：管理员 → 普通用户 → 子账号（分组）
- [x] 分组 = 激活码 = 子账号（一对一）
- [x] Windows客户端支持多激活码登录
- [x] 数据归属通过激活码+LineID确定
- [x] 平台类型：Line、Line Business
- [x] 去重范围：当前激活码、全局
- [x] 客户列表使用全局去重
- [x] 在线判断：WebSocket连接状态
- [x] 进线统计：当日/总计/重复
- [x] 置零时间：每个分组独立设置
- [x] 移除所有导出功能
- [x] 子账号登录：激活码+密码（可选）
- [x] 子账号权限：和普通用户一样，但数据限定在自己分组


