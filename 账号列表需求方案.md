# Line账号列表管理 - 需求方案

> **版本**: v1.0
> **更新日期**: 2025-12-21
> **说明**: 基于CEO SCRM系统账号列表页面设计

---

## 📋 页面概述

### 核心功能
展示所有激活码下登录的Line账号详情，支持按平台类型筛选、在线状态筛选、搜索等功能。

### 页面路径
`/account-list`

### 页面说明
账号下所有激活码登录的APP账号详情

---

## 🏷️ 平台类型

### 平台筛选区域

**位置**: 页面顶部筛选区

**显示方式**: 复选框组

**平台类型**:
```
平台：
☑ 全选
☑ Line（287）
☑ Line Business（235）
```

### 平台字段定义

#### 1. platform_type
- **字段名**: `platform_type`
- **类型**: `VARCHAR(20)`
- **默认值**: `line`
- **可选值**: 
  - `line` - Line普通版
  - `line_business` - Line Business商业版

**数据库枚举**:
```sql
CREATE TYPE platform_type_enum AS ENUM ('line', 'line_business');

ALTER TABLE line_accounts 
ADD COLUMN platform_type platform_type_enum DEFAULT 'line';
```

**显示逻辑**:
- 平台筛选显示格式：`Line（287）` 其中287是该平台账号数量
- 支持多选筛选
- 全选时显示所有平台账号
- 取消全选后，按勾选的平台筛选

---

## 🔍 筛选功能

### 筛选条件

#### 1. 所属激活码
- **字段**: `activation_code`
- **类型**: 文本输入框
- **占位符**: 默认显示（无占位符文本）
- **功能**: 输入激活码进行筛选

**示例**:
```
[vvAF52tj        ]
```

#### 2. 用户名/账号ID搜索
- **字段**: `username` 或 `line_id`
- **类型**: 下拉选择 + 文本输入框组合
- **下拉选项**:
  - 用户名
  - 账号ID
  - 手机号（可选）
  - 备注（可选）
- **占位符**: "请输入"

**示例**:
```
[用户名 ▼]  [请输入         ]
```

**搜索逻辑**:
- 根据下拉选择的字段类型进行模糊搜索
- 支持部分匹配

#### 3. 在线状态筛选
- **字段**: `online_status`
- **类型**: 下拉选择
- **默认**: "请选择在线状态"
- **选项**:
  - 全部
  - 在线
  - 用户主动退出
  - 异常离线

**示例**:
```
[请选择在线状态 ▼]
```

### 筛选操作按钮
```
[🔍 搜索]  [🔄 重选]
```

- **搜索**: 应用筛选条件
- **重选**: 清空所有筛选条件，恢复默认状态

---

## 📊 列表字段定义

### 表格列结构

| 列名 | 字段名 | 说明 | 是否保留 |
|-----|-------|------|---------|
| ☑ | - | 复选框 | ✅ 保留 |
| 序号 | - | 自动编号 | ✅ 保留 |
| 主账号详情 | `display_name` + `line_id` | 显示名称和Line ID | ✅ 保留 |
| 手机号 | `phone_number` | 绑定的手机号 | ✅ 保留 |
| 在线状态 | `online_status` | 当前在线状态 | ✅ 保留 |
| 所属激活码 | `activation_code` + `remark` | 激活码和备注 | ✅ 保留 |
| 备注 | `account_remark` | 账号备注信息 | ✅ 保留 |
| 首登时间/最后活跃时间 | `first_login_at` + `last_active_at` | 时间信息 | ✅ 保留 |
| ~~IP代理~~ | ~~`proxy_ip` + `geo_location`~~ | ~~IP和地理位置~~ | ❌ 移除 |
| ~~版本号~~ | ~~`app_version`~~ | ~~APP版本号~~ | ❌ 移除 |
| 主页地址 | `profile_url` | Line主页链接 | ✅ 保留 |
| 二维码 | `qr_code_url` | 二维码图片 | ✅ 保留 |
| 操作 | - | 操作按钮 | ✅ 保留 |

---

## 📝 字段详细说明

### 1. 序号
- **显示**: 自动编号，从1开始
- **示例**: `529`, `528`, `527`

---

### 2. 主账号详情
- **字段名**: `display_name` + `line_id`
- **类型**: `VARCHAR(100)` + `VARCHAR(100)`
- **说明**: 显示Line账号的显示名称和Line ID

**显示方式**:
```
[平台图标] [Business图标] 
藤本水花
@034gytbs
```

**图标说明**:
- 第一个图标: 平台类型图标（Line或其他）
- 第二个图标: 如果是Line Business，显示Business标识

**数据结构**:
```json
{
  "display_name": "藤本水花",
  "line_id": "@034gytbs",
  "platform_type": "line"
}
```

---

### 3. 手机号
- **字段名**: `phone_number`
- **类型**: `VARCHAR(20)`
- **说明**: 该Line账号绑定的手机号码
- **显示**: 如果没有绑定，显示为空

**示例**:
```
+886123456789
（空）
```

---

### 4. 在线状态
- **字段名**: `online_status`
- **类型**: `VARCHAR(20)`
- **说明**: 当前Line账号的在线状态

**可选值**:
- `在线` - 正常在线
- `用户主动退出` - 用户主动登出
- `异常离线` - 异常掉线

**显示方式**:
```
在线            (绿色文字)
用户主动退出    (灰色文字)
异常离线        (红色文字)
```

**状态判断逻辑**:
```python
# Windows客户端上报状态
if heartbeat_timeout:
    status = "异常离线"
elif user_logout:
    status = "用户主动退出"
else:
    status = "在线"
```

---

### 5. 所属激活码
- **字段名**: `activation_code` + `group_remark`
- **类型**: `VARCHAR(32)` + `VARCHAR(255)`
- **说明**: 该账号所属的激活码及其备注信息

**显示方式**:
```
vvAF52tj        (可点击，跳转到激活码详情)
阿乐兼职进粉    (备注信息，可点击)
```

**交互**:
- 激活码可点击，跳转到对应的激活码详情页
- 备注可点击，快速定位到该激活码的分组列表

**示例**:
```
qxK5JZHP
妹子
```

---

### 6. 备注
- **字段名**: `account_remark`
- **类型**: `TEXT`
- **说明**: 该Line账号的备注信息（多个备注用空格分隔）

**显示方式**:
```
停粉 大明 安澜2
周伯通
死号 大明 周伯通
```

**编辑功能**:
- 支持快速编辑
- 可添加多个标签式备注
- 备注之间用空格分隔

---

### 7. 首登时间/最后活跃时间
- **字段名**: `first_login_at` / `last_active_at`
- **类型**: `TIMESTAMP` / `TIMESTAMP`
- **说明**: 
  - **首登时间**: 该账号第一次登录的时间
  - **最后活跃时间**: 最后一次活跃（心跳）的时间

**显示方式**: 两行显示
```
2025-12-21 18:10:49
2025-12-21 18:10:49
```

**排序功能**:
- 支持按首登时间排序
- 支持按最后活跃时间排序

---

### 8. 主页地址
- **字段名**: `profile_url`
- **类型**: `VARCHAR(500)`
- **说明**: Line账号的主页链接

**显示方式**: 可点击的链接
```
https://line.me/R/ti/p/@034gytbs    (蓝色可点击链接)
https://line.me/ti/p/~dk36289
```

**交互**:
- 点击链接在新窗口打开Line主页
- 支持复制链接功能

**URL格式**:
- `https://line.me/R/ti/p/@{line_id}` - 使用@开头的ID
- `https://line.me/ti/p/~{line_id}` - 使用普通ID

---

### 9. 二维码
- **字段名**: `qr_code_url`
- **类型**: `VARCHAR(255)`
- **说明**: 该Line账号的加好友二维码图片

**显示方式**: 小图标缩略图
```
[QR Code图片] (40x40像素)
```

**交互**:
- 点击图片，弹出大图预览
- 支持下载二维码
- 支持复制二维码图片

**生成逻辑**:
- 根据profile_url自动生成二维码
- 保存到服务器静态文件目录

---

### 10. 操作
- **字段名**: -
- **类型**: 按钮
- **说明**: 对该账号的操作

**操作按钮**:
```
[📋 日志记录]
```

**功能说明**:
- **日志记录**: 查看该账号的上下线日志记录

---

## ⚙️ 批量操作功能

### 批量操作按钮

**位置**: 筛选区域下方

**按钮**:
```
[移除账号] (disabled)    灰色不可用，勾选后激活
[强制下线] (disabled)    灰色不可用，勾选后激活
```

### 1. 移除账号
- **功能**: 批量移除选中的Line账号
- **触发条件**: 勾选至少一个账号
- **确认提示**: "确定要移除选中的X个账号吗？移除后将无法恢复。"
- **操作结果**: 
  - 软删除账号（deleted_at字段标记）
  - 或彻底删除（根据业务需求）

### 2. 强制下线
- **功能**: 强制选中的账号下线
- **触发条件**: 勾选至少一个在线状态的账号
- **确认提示**: "确定要强制下线选中的X个账号吗？"
- **操作结果**: 
  - 向Windows客户端发送强制下线指令
  - 更新账号状态为"用户主动退出"

---

## 📱 列表页面布局

### 页面结构
```
┌─────────────────────────────────────────────────────────────┐
│  📋 账号列表                                                 │
│  说明：账号下所有激活码登录的APP账号详情                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  平台：                                                       │
│  ☑ 全选  ☑ Line（287）  ☑ Line Business（235）              │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [筛选区域]                                                   │
│  ┌──────────┬──────────────┬────────────┐                   │
│  │所属激活码│[用户名 ▼][搜索]│在线状态    │                   │
│  └──────────┴──────────────┴────────────┘                   │
│                                                               │
│  [🔍 搜索]  [🔄 重选]                                        │
│                                                               │
│  [移除账号]  [强制下线]                                       │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [数据表格]                                                   │
│  ┌──┬───┬────────┬────┬────┬────────┬───┬──────┬─────┬───┐│
│  │☑│序号│主账号详情│手机号│状态│所属激活码│备注│时间  │主页│操作││
│  ├──┼───┼────────┼────┼────┼────────┼───┼──────┼─────┼───┤│
│  │☐│529│藤本水花   │    │退出│vvAF52tj │   │18:10:49│line.me│日志││
│  │  │   │@034gytbs │    │    │阿乐兼职  │   │18:10:49│[QR]│    ││
│  │☐│528│藤本 水花  │    │退出│vvAF52tj │   │18:09:39│line.me│日志││
│  │  │   │@514chylp │    │    │阿乐兼职  │   │18:09:40│[QR]│    ││
│  │☐│526│千尋       │    │在线│qxK5JZHP │停粉│16:45:57│line.me│日志││
│  │  │   │dk36289   │    │    │妹子      │大明│18:02:11│[QR]│    ││
│  └──┴───┴────────┴────┴────┴────────┴───┴──────┴─────┴───┘│
│                                                               │
│  共 529 条    [10条/页 ▼]  [◀] [1][2][3][4][5][6]...[53] [▶]│
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 数据库表结构

### line_accounts 表（Line账号表）
```sql
CREATE TABLE line_accounts (
    id SERIAL PRIMARY KEY,
    
    -- 所属分组
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    activation_code VARCHAR(32) NOT NULL,              -- 冗余字段，方便查询
    
    -- 平台类型（新增字段）
    platform_type VARCHAR(20) DEFAULT 'line',          -- 'line' | 'line_business'
    
    -- Line账号信息
    line_id VARCHAR(100) UNIQUE NOT NULL,              -- Line ID (如 @034gytbs)
    display_name VARCHAR(100),                         -- 显示名称
    phone_number VARCHAR(20),                          -- 手机号
    
    -- 在线状态
    online_status VARCHAR(20) DEFAULT 'offline',       -- 'online' | 'user_logout' | 'abnormal_offline'
    last_active_at TIMESTAMP,                          -- 最后活跃时间
    first_login_at TIMESTAMP,                          -- 首次登录时间
    
    -- 账号信息
    profile_url VARCHAR(500),                          -- 主页地址
    qr_code_url VARCHAR(255),                          -- 二维码路径
    account_remark TEXT,                               -- 账号备注
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,                              -- 软删除
    
    -- 索引
    INDEX idx_group_id (group_id),
    INDEX idx_activation_code (activation_code),
    INDEX idx_platform_type (platform_type),
    INDEX idx_online_status (online_status),
    INDEX idx_line_id (line_id),
    INDEX idx_deleted (deleted_at),
    INDEX idx_last_active (last_active_at)
);
```

### 平台类型枚举（PostgreSQL）
```sql
CREATE TYPE platform_type_enum AS ENUM ('line', 'line_business');

ALTER TABLE line_accounts 
ALTER COLUMN platform_type TYPE platform_type_enum 
USING platform_type::platform_type_enum;
```

---

## 📋 日志记录功能

### 功能说明
点击列表中的"日志记录"按钮，弹出或跳转到该账号的上下线日志记录页面。

### 日志记录内容

**日志类型**:
- 上线日志
- 下线日志

### 日志字段

| 字段名 | 说明 |
|-------|------|
| 序号 | 日志序号 |
| Line账号 | 显示名称 + Line ID |
| 状态变化 | 离线→在线 / 在线→离线 |
| 变化原因 | 用户登录 / 用户登出 / 异常离线 / 强制下线 |
| 发生时间 | 状态变化的时间 |
| IP地址 | 发生变化时的IP（可选） |

### 日志示例

| 序号 | Line账号 | 状态变化 | 变化原因 | 发生时间 | IP地址 |
|-----|---------|---------|---------|---------|--------|
| 1 | 藤本水花<br>@034gytbs | 离线→在线 | 用户登录 | 2025-12-21 18:10:49 | 202.32.206.113 |
| 2 | 藤本水花<br>@034gytbs | 在线→离线 | 用户主动退出 | 2025-12-21 19:30:22 | 202.32.206.113 |
| 3 | 藤本水花<br>@034gytbs | 离线→在线 | 用户登录 | 2025-12-21 20:15:30 | 202.32.206.113 |
| 4 | 藤本水花<br>@034gytbs | 在线→离线 | 异常离线 | 2025-12-21 22:05:18 | - |

### 筛选功能
- 时间范围筛选
- 状态类型筛选（上线/下线）
- 原因筛选（登录/登出/异常/强制）

### 数据库表结构

```sql
CREATE TABLE account_status_logs (
    id BIGSERIAL PRIMARY KEY,
    line_account_id INTEGER NOT NULL REFERENCES line_accounts(id) ON DELETE CASCADE,
    
    -- 状态变化
    from_status VARCHAR(20) NOT NULL,                  -- 'online' | 'offline'
    to_status VARCHAR(20) NOT NULL,                    -- 'online' | 'offline'
    
    -- 变化原因
    reason VARCHAR(50) NOT NULL,                       -- 'user_login' | 'user_logout' | 'abnormal_offline' | 'force_offline'
    
    -- 其他信息
    ip_address VARCHAR(50),                            -- IP地址
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   -- 发生时间
    
    -- 索引
    INDEX idx_line_account (line_account_id, occurred_at DESC),
    INDEX idx_occurred_at (occurred_at)
);

-- 按月分区
CREATE TABLE account_status_logs_2025_01 PARTITION OF account_status_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 日志记录触发时机

1. **用户登录** - Windows客户端上报账号上线
2. **用户登出** - Windows客户端上报账号主动下线
3. **异常离线** - 心跳超时，系统自动标记
4. **强制下线** - 管理员操作强制下线

---

## 📊 统计信息

### 平台统计
在平台筛选区域显示各平台账号数量：
- Line（287）
- Line Business（235）

---

## 🎯 下一步需要确认的内容

1. **日志记录页面** - 点击"日志记录"后展示什么内容
2. **激活码详情页面** - 点击激活码后跳转的页面
3. **进线统计** - 如何展示进线数据
4. **强制下线逻辑** - 如何通知Windows客户端下线
5. **移除账号后的处理** - 是否需要通知Windows客户端

---

## ✅ 当前已确认需求

- [x] 平台类型字段（line / line_business）
- [x] 列表字段定义（移除IP代理、版本号）
- [x] 筛选功能
- [x] 批量操作（移除账号、强制下线）
- [x] 数据库表结构
- [x] 实时更新逻辑
- [ ] 日志记录详情
- [ ] 激活码详情页面
- [ ] 进线统计展示


